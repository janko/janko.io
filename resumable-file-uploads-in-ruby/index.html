<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Resumable File Uploads in Ruby | Janko Marohnić</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Resumable File Uploads in Ruby" />
<meta name="author" content="Janko Marohnić" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I recently released tus-ruby-server, a Ruby server implementation for tus, an open protocol for resumable file uploads built on HTTP." />
<meta property="og:description" content="I recently released tus-ruby-server, a Ruby server implementation for tus, an open protocol for resumable file uploads built on HTTP." />
<link rel="canonical" href="https://janko.io/resumable-file-uploads-in-ruby/" />
<meta property="og:url" content="https://janko.io/resumable-file-uploads-in-ruby/" />
<meta property="og:site_name" content="Janko Marohnić" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-09-04T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Resumable File Uploads in Ruby" />
<meta name="twitter:site" content="@jankomarohnic" />
<meta name="twitter:creator" content="@jankomarohnic" />
<meta property="article:publisher" content="https://www.facebook.com/janko.marohnic/" />
<script type="application/ld+json">
{"headline":"Resumable File Uploads in Ruby","dateModified":"2016-09-04T00:00:00+02:00","datePublished":"2016-09-04T00:00:00+02:00","@type":"BlogPosting","author":{"@type":"Person","name":"Janko Marohnić"},"description":"I recently released tus-ruby-server, a Ruby server implementation for tus, an open protocol for resumable file uploads built on HTTP.","mainEntityOfPage":{"@type":"WebPage","@id":"https://janko.io/resumable-file-uploads-in-ruby/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://janko.io/images/logo.png"},"name":"Janko Marohnić"},"url":"https://janko.io/resumable-file-uploads-in-ruby/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link type="application/atom+xml" rel="alternate" href="https://janko.io/feed.xml" title="Janko Marohnić" />
    <link rel="stylesheet" href="/css/bundle.css">
    <script>
      function updateTheme() {
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
      }
      updateTheme()
    </script>
  </head>

  <body class="text-xl text-slate-700 dark:bg-slate-900 dark:text-slate-400 min-h-screen flex flex-col">
    <header class="py-3 px-4 bg-gray-100 border-b dark:bg-slate-800/70 dark:border-slate-700">
      <div class="max-w-screen-sm md:max-w-screen-md mx-auto flex items-center">
        <a class="text-lg xs:text-xl sm:text-2xl md:text-3xl font-semibold tracking-wide text-pink-700/80 hover:text-pink-800 dark:text-pink-500 dark:hover:text-pink-400 flex-1 transition" href="/">
          Janko Marohnić
        </a>

        <a class="flex items-center space-x-2 justify-self-center" href="/">
          <svg class="h-7 w-7 rounded lg:h-10 lg:w-10 lg:rounded-lg" role="img" aria-labelledby="logo-title" viewBox="0 0 64 64">
            <title id="logo-title">logo</title>
            <clipPath id="topLeft"><path d="M64,0.025l-64,64l0,-64l64,0Z"></path></clipPath>
            <clipPath id="bottomRight"><path d="M0,64l64,-64l0,64l-64,0Z"></path></clipPath>
            <g clip-path="url(#topLeft)"><rect class="fill-current text-pink-500" x="0.025" y="0.025" width="64" height="64"></rect><path class="fill-current text-white" d="M31.989,22.518c-0.031,-4.597 -0.902,-8.134 -2.612,-10.613c-1.71,-2.478 -4.165,-3.717 -7.365,-3.717c-3.2,0 -5.655,1.251 -7.365,3.753c-1.71,2.502 -2.565,6.114 -2.565,10.836l0,6.471c0.063,4.549 0.953,8.043 2.671,10.483c1.718,2.439 4.153,3.659 7.306,3.659c3.185,0 5.636,-1.255 7.354,-3.765c1.717,-2.51 2.576,-6.134 2.576,-10.871l0,-6.236Zm-6.682,7.647c-0.032,2.605 -0.31,4.538 -0.836,5.801c-0.525,1.263 -1.329,1.894 -2.412,1.894c-1.145,0 -1.988,-0.675 -2.529,-2.024c-0.542,-1.349 -0.812,-3.404 -0.812,-6.165l0,-8.541c0.078,-4.942 1.176,-7.413 3.294,-7.413c1.13,0 1.961,0.675 2.494,2.024c0.534,1.349 0.801,3.373 0.801,6.071l0,8.353Z"></path></g><g clip-path="url(#bottomRight)"><rect class="fill-current text-pink-700" x="0.025" y="0.025" width="64" height="64"></rect><path class="fill-current text-white" d="M44.945,55.261l-6.553,0l0,-25.659l-6.392,2.469l0,-5.446l12.253,-5.007l0.692,0l0,33.643Z"></path><
          </svg>
        </a>

        <span class="flex-1 flex space-x-2 justify-end">
          <button type="button" class="theme-reset rounded-full bg-sky-200 dark:bg-sky-900 px-2.5 py-1 text-xs font-medium text-sky-700 dark:text-white shadow-sm dark:hover:bg-sky-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-200">Reset to OS</button>

          <button type="button" class="theme-toggle bg-gray-200 relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transitikon-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-pink-700 focus:ring-offset-2 dark:focus:ring-pink-500 dark:focus:ring-offset-slate-900" role="switch" aria-checked="false">
            <span class="sr-only">Use setting</span>
            <span class="theme-toggle-ring translate-x-0 pointer-events-none relative inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out">
              <span class="theme-toggle-light opacity-100 duration-200 ease-in absolute inset-0 flex h-full w-full items-center justify-center transition-opacity" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4kkkkkkk h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                </svg>
              </span>
              <span class="theme-toggle-dark opacity-0 duration-100 ease-out absolute inset-0 flex h-full w-full items-center justify-center transition-opacity" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-pink-500">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                </svg>
              </span>
            </span>
          </button>
        </span>
      </div>
    </header>

    <div class="flex-1 my-2 sm:my-4 mx-4">
      <main class="max-w-screen-sm md:max-w-screen-md mx-auto">
        <article class="mt-6">
  <time datetime="2016-09-04" class="flex items-center text-slate-400 text-sm md:text-base">
    <span class="h-4 md:h-5 w-0.5 rounded-full bg-slate-200 dark:bg-slate-500"></span>
    <span class="ml-3">September 04, 2016</span>
  </time>

  <h1 class="mt-5 sm:mt-6 text-3xl sm:text-4xl lg:text-5xl font-semibold text-slate-900 tracking-tight dark:text-slate-100">Resumable File Uploads in Ruby</h1>

  <div class="mt-6 sm:mt-8 markdown">
    <p>I recently released <a href="https://github.com/janko/tus-ruby-server">tus-ruby-server</a>, a Ruby server implementation for <a href="http://tus.io/">tus</a>,
an open protocol for resumable file uploads built on HTTP.</p>

<h2 id="protocol">Protocol</h2>

<p>Let’s first briefly explain what is tus. Tus is a <a href="http://tus.io/protocols/resumable-upload.html">specification</a> that
describes the communication between the client and the server through HTTP for
achieving reliable and resumable file uploads, even on unstable networks. Check
out the <a href="http://tus.io/demo.html">demo</a>.</p>

<p>“Resumable upload” doesn’t mean giving your user a button to resume the upload
whenever there is a network hiccup. It means having the client automatically
reinitiate interrupted uploads without the user knowing about it. Tus enables
resuming the upload even after the user closes the browser or shuts down the
device, as long as the user selects the same file.</p>

<p>Tus was created by <a href="https://transloadit.com/">Transloadit</a>, and has received feedback from well-known
companies like Vimeo, Google and GitHub.</p>

<h2 id="implementations">Implementations</h2>

<p>There are many client-side implementations, including <a href="https://github.com/tus/tus-js-client">JavaScript</a>,
<a href="https://github.com/tus/TUSKit">iOS</a> and <a href="https://github.com/tus/tus-android-client">Android</a>, as well as server-side
implementations, covering <a href="https://github.com/tus/tusd">Go</a>, <a href="https://github.com/tus/tus-node-server">Node.js</a>, <a href="https://github.com/matthoskins1980/Flask-Tus">Python</a>, <a href="https://github.com/terrischwartz/tus_servlet">Java</a>, <a href="https://github.com/leblanc-simon/php-tus">PHP</a>, <a href="https://github.com/smatsson/tusdotnet">.NET</a> and
others.</p>

<p>There already is an existing Ruby server implementation, <a href="https://github.com/picocandy/rubytus">Rubytus</a>. However,
there are two main reasons why I decided to write my own:</p>

<p>One reason is that at the time of this writing Rubytus supported an older
version of the protocol. When I attempted to bring it to tus 1.0, I realized
that many things have changed since that version.</p>

<p>Another reason is that it’s written in a non-standard web framework, <a href="https://github.com/postrank-labs/goliath">Goliath</a>.
Goliath is a non-blocking Ruby web framework built on top of <a href="https://github.com/eventmachine/eventmachine">EventMachine</a>. I
think Goliath is great when you want to scale apps that do a lot of IO (like
database writing and HTTP requests), but here we’re just writing files to the
filesystem. And while Goliath definitely has a nice callback-less API, you
still have to be aware that you’re writing asynchronous code, which made it
difficult for me to precisely implement the protocol.</p>

<h2 id="ruby-server">Ruby server</h2>

<p>The <a href="https://github.com/janko/tus-ruby-server">tus-ruby-server</a> fully implements the tus protocol with all its
extensions, and it’s written in <a href="https://github.com/jeremyevans/roda">Roda</a>, for me the best web framework for
writing APIs. With Roda you can route and handle requests in a very linear and
DRY way, which allowed me to precisely follow the specification and return the
appropriate status and HTTP headers for various situations.</p>

<p>But from the developer’s perspective, <a href="https://github.com/janko/tus-ruby-server">tus-ruby-server</a> is just a Rack app
which you can run standalone or as part of your app:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Gemfile</span>
<span class="n">gem</span> <span class="s2">"tus-server"</span>
</code></pre></div></div>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config.ru</span>
<span class="nb">require</span> <span class="s2">"tus/server"</span>

<span class="n">map</span> <span class="s2">"/files"</span> <span class="k">do</span>
  <span class="n">run</span> <span class="no">Tus</span><span class="o">::</span><span class="no">Server</span>
<span class="k">end</span>
</code></pre></div></div>

<p>On the client-side you can now use <a href="https://github.com/tus/tus-js-client">tus-js-client</a> to listen on file select,
and initiate a tus upload to the endpoint.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">fileInput</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">change</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

  <span class="kd">var</span> <span class="nx">upload</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">tus</span><span class="p">.</span><span class="nc">Upload</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">endpoint</span><span class="p">:</span>  <span class="dl">"</span><span class="s2">http://localhost:9292/files/</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">chunkSize</span><span class="p">:</span> <span class="mi">15</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="c1">// 15MB</span>
  <span class="p">});</span>

  <span class="nx">upload</span><span class="p">.</span><span class="nf">start</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div></div>

<p>After upload is complete you will get a URL to the uploaded file, and you’ll
probably want to attach it to a database record. <a href="https://github.com/shrinerb/shrine">Shrine</a> is one file
attachment library that supports attaching by custom URLs using <a href="https://github.com/shrinerb/shrine-url">shrine-url</a>,
see <a href="https://github.com/shrinerb/shrine-tus-demo">shrine-tus-demo</a> on how you can integrate these.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:9292/files/ebfe84d3921ce31fe603c6a9ae5f81b8
</code></pre></div></div>

<p>Other popular file attachment libraries like CarrierWave, Paperclip, Refile or
Dragonfly also support attaching remote files via URLs, but they will also
automatically download the file. This is not really feasible here, because
these files will typically be fairly large (that’s why we’re using this
protocol in the first place).</p>

<p>Shrine allows you to save only the URL, and spawn a background job which will
upload this file to a storage of your choice. This keeps the form submission
instantaneous.</p>

<p>Ok, now that we got the integration out of the way, I thought it would be
interesting to go over some parts of the tus protocol, to see how it can
improve the general user experience around file uploads.</p>

<h3 id="uploading">Uploading</h3>

<p>Tus enables file data to be sent in multiple PATCH requests:</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">PATCH</span> <span class="nn">/files/{uid}</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/offset+octet-stream</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">30</span>
<span class="na">Upload-Offset</span><span class="p">:</span> <span class="s">0</span>
<span class="na">Tus-Resumable</span><span class="p">:</span> <span class="s">1.0.0</span>

[ first 30 bytes ]
</code></pre></div></div>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">PATCH</span> <span class="nn">/files/{uid}</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/offset+octet-stream</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">70</span>
<span class="na">Upload-Offset</span><span class="p">:</span> <span class="s">30</span>
<span class="na">Tus-Resumable</span><span class="p">:</span> <span class="s">1.0.0</span>

[ next 70 bytes ]
</code></pre></div></div>

<p>The interesting header here is <code class="language-plaintext highlighter-rouge">Upload-Offset</code>, which allows the client to
continue sending more data to an existing upload. This means the client can
split large files into multiple chunks, and repeat PATCH requests that failed
due to network issues.</p>

<h3 id="concatenation">Concatenation</h3>

<p>In addition to appending to an existing upload, the protocol also supports
uploading the chunks individually, and then concatenating them into a single
file. This allows the client to upload multiple chunks in parallel, which
can provide a significant overall speedup:</p>

<blockquote>
  <p>[…] on our internal network, sending a 110 MB file to S3 with chunk sizes of 5 MB took about 22 seconds when chunks were uploaded one-at-a-time (with concurrent chunking disabled). When maxing out the default maxConnections for that file (3 chunks at once, concurrent chunking enabled) the same file uploaded in about 12 seconds.</p>

  <p>— Ray Nicholus, creator of <a href="http://fineuploader.com/">FineUploader</a></p>
</blockquote>

<p>We could for example upload two chunks:</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">PATCH</span> <span class="nn">/files/a</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Upload-Concat</span><span class="p">:</span> <span class="s">partial</span>
<span class="na">Upload-Offset</span><span class="p">:</span> <span class="s">0</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">5</span>

hello
</code></pre></div></div>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">PATCH</span> <span class="nn">/files/b</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Upload-Concat</span><span class="p">:</span> <span class="s">partial</span>
<span class="na">Upload-Offset</span><span class="p">:</span> <span class="s">0</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">6</span>

 world
</code></pre></div></div>

<p>And then concatenate them into a single file:</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/files</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Upload-Concat</span><span class="p">:</span> <span class="s">final;/files/a /files/b</span>
</code></pre></div></div>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Location</span><span class="p">:</span> <span class="s">/files/ab</span>
</code></pre></div></div>

<p>The length of the final resource is now 11 bytes consisting of <code class="language-plaintext highlighter-rouge">hello world</code>:</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">HEAD</span> <span class="nn">/files/ab</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</code></pre></div></div>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Upload-Length</span><span class="p">:</span> <span class="s">11</span>
<span class="na">Upload-Concat</span><span class="p">:</span> <span class="s">final;/files/a /files/b</span>
</code></pre></div></div>

<h3 id="checksum">Checksum</h3>

<p>Networks are not reliable, and sometimes <a href="https://github.com/tus/tus-resumable-upload-protocol/issues/7#issuecomment-16568773">bytes can get lost</a>. That’s why tus
allows the client to send a checksum of the data it’s sending.</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">PATCH</span> <span class="nn">/files/{uid}</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">11</span>
<span class="na">Upload-Offset</span><span class="p">:</span> <span class="s">0</span>
<span class="na">Upload-Checksum</span><span class="p">:</span> <span class="s">sha1 Kq5sNclPz7QV2+lfQIuc6R7oRu0=</span>

hello world
</code></pre></div></div>

<p>When server receives the data, it too can generate a checksum of the received
data using the same algorithm, and verify that it matches the received one.</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">204</span> <span class="ne">No Content</span>
<span class="na">Upload-Offset</span><span class="p">:</span> <span class="s">11</span>
</code></pre></div></div>

<h3 id="termination">Termination</h3>

<p>In addition to resuming, with tus you can also give users the ability to
terminate uploads, which deletes the data that was uploaded up to that point.</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">DELETE</span> <span class="nn">/files/{uid}</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</code></pre></div></div>

<h3 id="storage">Storage</h3>

<p>The tus-ruby-server implementation by default stores uploaded files on the
filesystem. However, the downside of storing files on the filesystem is that
it isn’t distributed, so for the resumable uploads to work you would have to
host tus-ruby-server on a single server.</p>

<p>That might or might not be a bottleneck, depending on the rate of file uploads
you’re accepting. Alternatively you can choose the Mongo <a href="https://docs.mongodb.org/v3.0/core/gridfs/">GridFS</a> storage,
which among other things is convenient for multi-server setup.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"tus/server"</span>
<span class="nb">require</span> <span class="s2">"tus/storage/gridfs"</span> <span class="c1"># requires the "mongo" gem</span>

<span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"mongodb://127.0.0.1:27017/mydb"</span><span class="p">)</span>
<span class="no">Tus</span><span class="o">::</span><span class="no">Server</span><span class="p">.</span><span class="nf">opts</span><span class="p">[</span><span class="ss">:storage</span><span class="p">]</span> <span class="o">=</span> <span class="no">Tus</span><span class="o">::</span><span class="no">Storage</span><span class="o">::</span><span class="no">Gridfs</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">client: </span><span class="n">client</span><span class="p">)</span>
</code></pre></div></div>

<p>You can also write your own storage which implements the same interface as
<a href="https://github.com/janko/tus-ruby-server/blob/master/lib/tus/storage/filesystem.rb"><code class="language-plaintext highlighter-rouge">Tus::Storage::Filesystem</code></a> and <a href="https://github.com/janko/tus-ruby-server/blob/master/lib/tus/storage/gridfs.rb"><code class="language-plaintext highlighter-rouge">Tus::Storage::Gridfs</code></a>.</p>

<h2 id="limitations">Limitations</h2>

<p>One advantage of Rubytus is that the Goliath web framework is able to handle
interrupted PATCH requests, by saving all the data it has received before the
HTTP connection was closed.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Code is from https://github.com/picocandy/rubytus</span>

<span class="k">class</span> <span class="nc">TusServer</span> <span class="o">&lt;</span> <span class="no">Goliath</span><span class="o">::</span><span class="no">API</span>
  <span class="c1"># executed when headers are received</span>
  <span class="k">def</span> <span class="nf">on_headers</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="c1"># executed whenever part of the body is received</span>
  <span class="k">def</span> <span class="nf">on_body</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s2">"REQUEST_METHOD"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"PATCH"</span>
      <span class="n">env</span><span class="p">[</span><span class="s2">"api.buffers"</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">data</span> <span class="c1"># save the received data</span>
    <span class="k">else</span>
      <span class="n">env</span><span class="p">[</span><span class="s2">"rack.input"</span><span class="p">]</span> <span class="o">=</span> <span class="no">StringIO</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># default behaviour</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># executed when the connection is closed (either completed or interrupted)</span>
  <span class="k">def</span> <span class="nf">on_close</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s2">"REQUEST_METHOD"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"PATCH"</span>
      <span class="n">storage</span><span class="p">.</span><span class="nf">patch_file</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s2">"api.uid"</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s2">"api.buffers"</span><span class="p">])</span> <span class="c1"># store the received data</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Tus-ruby-server is implemented in Roda, which is built on top of Rack (like most
other web frameworks), and from research that I performed, web servers for Rack
applications don’t have a configuration option for forwarding interrupted
requests to the app.</p>

<p>By default tus-js-client will use only a single PATCH request to upload the
whole file, and send additional ones if the connection gets interrupted. So you
just need to configure tus-js-client or whichever client library you’re using
to upload in multiple chunks. This way if the connection gets interrupted, all
previously uploaded chunks will remain on the server.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">new</span> <span class="nx">tus</span><span class="p">.</span><span class="nc">Upload</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">endpoint</span><span class="p">:</span>  <span class="dl">"</span><span class="s2">http://localhost:9292/files/</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">chunkSize</span><span class="p">:</span> <span class="mi">15</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="c1">// 15MB</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Since chunked uploads can even significantly speed up the general upload if you
use parallelization, not being able to resume an upload of a single PATCH
request practically shouldn’t be a significant limitation.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I’m really excited that, rather than each company implementing their own
protocol, we now have an open stable resumable upload protocol which we can all
agree on, and build generic client and server libraries which everyone can use.</p>

<p>With <a href="https://github.com/janko/tus-ruby-server">tus-ruby-server</a> and <a href="https://github.com/shrinerb/shrine">Shrine</a> on the server, and
<a href="https://github.com/tus/tus-js-client">tus-js-client</a> / <a href="https://github.com/tus/TUSKit">TUSKit</a> / <a href="https://github.com/tus/tus-android-client">tus-android-client</a> on the client, anyone can now add
resumable file uploads to their Ruby applications.</p>


  </div>
</article>

<div class="mt-8 md:mt-10">
  <div class="flex items-center space-x-4 md:space-x-6 mx-0 lg:-mx-6 bg-blue-50 border border-sky-200 bg-sky-50 px-4 py-3 md:py-5 md:px-6 rounded-xl overflow-x-scroll dark:bg-sky-950 dark:border-sky-600">
  <img src="/images/me.jpg" class="h-20 xs:h-24 sm:h-32 rounded-xl">
  <div class="flex flex-col justify-center">
    
      <h3 class="font-medium text-slate-900 dark:text-slate-200 mb-2 text-xl xs:text-2xl">Janko Marohnić</h3>
    
    <p class="text-slate-900 dark:text-slate-200 text-sm xs:text-base md:text-lg hidden sm:block">Ruby developer, Rails critic, open source maintainer, authentication consultant.</p>

    <div class="mt-2 xs:mt-4 sm:mt-5 flex items-center space-x-3 xs:space-x-5">
      

      <a href="https://github.com/janko" title="GitHub" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 dark:hidden transition hover:scale-110" viewBox="0 0 24 24">
          <path xmlns="http://www.w3.org/2000/svg" d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path>
        </svg>
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 hidden dark:block transition hover:scale-110" viewBox="0 0 100 100">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z" fill="#fff"/>
        </svg>
      </a>
      <a href="https://twitter.com/jankomarohnic" title="Twitter" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 text-blue-400 transition hover:scale-110" viewBox="0 0 20 20" fill="currentColor">
          <path d="M17.316 6.246c0.008 0.162 0.011 0.326 0.011 0.488 0 4.99-3.797 10.742-10.74 10.742-2.133 0-4.116-0.625-5.787-1.697 0.296 0.035 0.596 0.053 0.9 0.053 1.77 0 3.397-0.604 4.688-1.615-1.651-0.031-3.046-1.121-3.526-2.621 0.23 0.043 0.467 0.066 0.71 0.066 0.345 0 0.679-0.045 0.995-0.131-1.727-0.348-3.028-1.873-3.028-3.703 0-0.016 0-0.031 0-0.047 0.509 0.283 1.092 0.453 1.71 0.473-1.013-0.678-1.68-1.832-1.68-3.143 0-0.691 0.186-1.34 0.512-1.898 1.861 2.285 4.644 3.787 7.781 3.945-0.064-0.277-0.097-0.564-0.097-0.861 0-2.084 1.689-3.773 3.774-3.773 1.086 0 2.067 0.457 2.756 1.191 0.859-0.17 1.667-0.484 2.397-0.916-0.282 0.881-0.881 1.621-1.66 2.088 0.764-0.092 1.49-0.293 2.168-0.594-0.506 0.758-1.146 1.422-1.884 1.953z"></path>
        </svg>
      </a>
      <a href="https://www.youtube.com/@jankomarohnic" title="YouTube" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-110" viewBox="0 0 159 110" fill="currentColor">
          <path d="m154 17.5c-1.82-6.73-7.07-12-13.8-13.8-9.04-3.49-96.6-5.2-122 0.1-6.73 1.82-12 7.07-13.8 13.8-4.08 17.9-4.39 56.6 0.1 74.9 1.82 6.73 7.07 12 13.8 13.8 17.9 4.12 103 4.7 122 0 6.73-1.82 12-7.07 13.8-13.8 4.35-19.5 4.66-55.8-0.1-75z" fill="#f00"/>
          <path d="m105 55-40.8-23.4v46.8z" fill="#fff"/>
        </svg>
      </a>
      <a href="https://www.linkedin.com/in/janko-marohnic/" title="LinkedIn" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-110" viewBox="0 0 72 72" width="72" xmlns="http://www.w3.org/2000/svg">
          <g fill="none" fill-rule="evenodd"><path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" fill="#007EBB"/><path d="M62,62 L51.315625,62 L51.315625,43.8021149 C51.315625,38.8127542 49.4197917,36.0245323 45.4707031,36.0245323 C41.1746094,36.0245323 38.9300781,38.9261103 38.9300781,43.8021149 L38.9300781,62 L28.6333333,62 L28.6333333,27.3333333 L38.9300781,27.3333333 L38.9300781,32.0029283 C38.9300781,32.0029283 42.0260417,26.2742151 49.3825521,26.2742151 C56.7356771,26.2742151 62,30.7644705 62,40.051212 L62,62 Z M16.349349,22.7940133 C12.8420573,22.7940133 10,19.9296567 10,16.3970067 C10,12.8643566 12.8420573,10 16.349349,10 C19.8566406,10 22.6970052,12.8643566 22.6970052,16.3970067 C22.6970052,19.9296567 19.8566406,22.7940133 16.349349,22.7940133 Z M11.0325521,62 L21.769401,62 L21.769401,27.3333333 L11.0325521,27.3333333 L11.0325521,62 Z" fill="#FFF"/></g>
        </svg>
      </a>
      <a href="https://speakerdeck.com/janko_m" title="Speaker Deck">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-110" viewBox="0 0 256 160">
          <g><path d="M106.932331,100 L50,100 C22.3857624,100 0,77.6142376 0,50 C0,22.3857624 22.3857624,0 50,0 L116.421053,0 C127.466748,0 136.421053,8.9543048 136.421053,20 C136.421053,31.0456952 127.466748,40 116.421053,40 L48.977444,40 C43.454596,40 38.977444,44.4771528 38.977444,50 C38.977444,55.5228472 43.454596,60 48.977444,60 L105.909774,60 C133.524012,60 155.909774,82.3857624 155.909774,110 C155.909774,137.614238 133.524012,160 105.909774,160 L20,160 C8.9543048,160 0,151.045695 0,140 C0,128.954305 8.9543048,120 20,120 L106.932331,120 C112.455178,120 116.932331,115.522847 116.932331,110 C116.932331,104.477153 112.455178,100 106.932331,100 Z M149.013633,160 C162.31303,151.005667 171.818454,136.66797 174.567639,120 L206.843433,120 C212.273117,120 216.674746,115.522847 216.674746,110 L216.674746,50 C216.674746,44.4771528 212.273117,40 206.843433,40 L148.210526,40 C152.880793,34.6924352 155.720602,27.683544 155.720602,20 C155.720602,12.316456 152.880793,5.3075648 148.210526,0 L216.674746,0 C238.393484,0 256,17.9086104 256,40 L256,120 C256,142.09139 238.393484,160 216.674746,160 L149.013633,160 Z" fill="#009287"></path></g>
        </svg>
      </a>
      <a href="mailto:janko@hey.com" title="Email">
        <svg class="w-7 h-7 text-red-500 transition hover:scale-110" viewBox="0 0 20 20" fill="currentColor">
          <path d="M1.574 5.286c0.488 0.262 7.248 3.894 7.5 4.029s0.578 0.199 0.906 0.199c0.328 0 0.654-0.064 0.906-0.199s7.012-3.767 7.5-4.029c0.489-0.263 0.951-1.286 0.054-1.286h-16.919c-0.897 0-0.435 1.023 0.053 1.286zM18.613 7.489c-0.555 0.289-7.387 3.849-7.727 4.027s-0.578 0.199-0.906 0.199-0.566-0.021-0.906-0.199-7.133-3.739-7.688-4.028c-0.39-0.204-0.386 0.035-0.386 0.219s0 7.293 0 7.293c0 0.42 0.566 1 1 1h16c0.434 0 1-0.58 1-1 0 0 0-7.108 0-7.292s0.004-0.423-0.387-0.219z"></path>
        </svg>
      </a>
    </div>
  </div>
</div>

</div>

<div class="mt-8 md:mt-10">
  
  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'twinblog'; // required: replace example with your forum shortname
    var disqus_identifier = '/resumable-file-uploads-in-ruby';
    var disqus_url = 'https://janko.io/resumable-file-uploads-in-ruby/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



</div>

      </main>
    </div>

    <div class="border-t py-7 mt-10 bg-gray-50 dark:bg-slate-950 dark:border-slate-700">
      <footer class="max-w-screen-sm md:max-w-screen-md mx-auto flex flex-col space-y-2 md:flex-row md:justify-between md:space-y-0 text-base">
        <ul class="inline-flex space-x-4 font-medium justify-center md:justify-left">
          <li><a class="transition hover:text-pink-600" href="/">Articles</a></li>
          <li><a class="transition hover:text-pink-600" href="/about">About</a></li>
          <li><a class="transition hover:text-pink-600" href="https://github.com/janko/janko.io">Source code</a></li>
        </ul>
        <p class="text-slate-500 text-center md:text-left">
          © 2023 Janko Marohnić. All rights reserved.
        </p>
      </footer>
    </div>

    
      <!-- Fathom - beautiful, simple website analytics -->
<script src="https://bouncy-van.janko.io/script.js" data-site="EKJCVCTX" defer></script>
<!-- / Fathom -->

    

    <script>
      function toggleClass(element, classNames, force) {
        classNames.split(' ').forEach(function(className) {
          element.classList.toggle(className, force)
        })
      }

      const btnToggle = document.querySelector('.theme-toggle')
      const btnReset = document.querySelector('.theme-reset')

      function syncTheme() {
        const enabled = document.documentElement.classList.contains('dark')

        const ring = btnToggle.querySelector('.theme-toggle-ring')
        const light = btnToggle.querySelector('.theme-toggle-light')
        const dark = btnToggle.querySelector('.theme-toggle-dark')

        toggleClass(btnToggle, 'bg-pink-500', enabled)
        toggleClass(btnToggle, 'bg-slate-200', !enabled)

        toggleClass(ring, 'translate-x-5', enabled)
        toggleClass(ring, 'translate-x-0', !enabled)

        toggleClass(light, 'opacity-0 duration-100 ease-out', enabled)
        toggleClass(light, 'opacity-100 duration-200 ease-in', !enabled)

        toggleClass(dark, 'opacity-100 duration-200 ease-in', enabled)
        toggleClass(dark, 'opacity-0 duration-100 ease-out', !enabled)
      }

      btnToggle.addEventListener('click', function() {
        const enabled = document.documentElement.classList.toggle('dark')

        localStorage.theme = enabled ? 'dark' : 'light'

        syncTheme()

        btnReset.classList.remove('hidden')
      })

      btnReset.addEventListener('click', function() {
        localStorage.removeItem('theme')

        updateTheme()
        syncTheme()

        btnReset.classList.add('hidden')
      })

      syncTheme()
      btnReset.classList.toggle('hidden', !('theme' in localStorage))
    </script>
  </body>
</html>
