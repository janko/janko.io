<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>What It Took to Build a Rails Integration for Rodauth | Janko Marohnić</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/favicon.ico?v=1" sizes="any">
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="What It Took to Build a Rails Integration for Rodauth" />
<meta name="author" content="Janko Marohnić" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="When Rodauth came out, I was excited to finally have a full-featured authentication framework that wasn’t tied to Rails, given that existing solutions required either Rails (Devise, Sorcery), or at least Active Record (Authlogic). Even though I mainly develop in Rails, I want other Ruby web frameworks to be viable alternatives, so I’m naturally drawn to generic solutions that everyone can use." />
<meta property="og:description" content="When Rodauth came out, I was excited to finally have a full-featured authentication framework that wasn’t tied to Rails, given that existing solutions required either Rails (Devise, Sorcery), or at least Active Record (Authlogic). Even though I mainly develop in Rails, I want other Ruby web frameworks to be viable alternatives, so I’m naturally drawn to generic solutions that everyone can use." />
<link rel="canonical" href="https://janko.io/what-it-took-to-build-a-rails-integration-for-rodauth/" />
<meta property="og:url" content="https://janko.io/what-it-took-to-build-a-rails-integration-for-rodauth/" />
<meta property="og:site_name" content="Janko Marohnić" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-10-12T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="What It Took to Build a Rails Integration for Rodauth" />
<meta name="twitter:site" content="@jankomarohnic" />
<meta name="twitter:creator" content="@jankomarohnic" />
<meta property="article:publisher" content="https://www.facebook.com/janko.marohnic/" />
<script type="application/ld+json">
{"datePublished":"2022-10-12T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://janko.io/what-it-took-to-build-a-rails-integration-for-rodauth/"},"author":{"@type":"Person","name":"Janko Marohnić"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://janko.io/images/logo.png"},"name":"Janko Marohnić"},"@type":"BlogPosting","description":"When Rodauth came out, I was excited to finally have a full-featured authentication framework that wasn’t tied to Rails, given that existing solutions required either Rails (Devise, Sorcery), or at least Active Record (Authlogic). Even though I mainly develop in Rails, I want other Ruby web frameworks to be viable alternatives, so I’m naturally drawn to generic solutions that everyone can use.","url":"https://janko.io/what-it-took-to-build-a-rails-integration-for-rodauth/","headline":"What It Took to Build a Rails Integration for Rodauth","dateModified":"2022-10-12T00:00:00+02:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link type="application/atom+xml" rel="alternate" href="https://janko.io/feed.xml" title="Janko Marohnić" />
    <link rel="stylesheet" href="/css/bundle.css">
    
      <script src="https://cdn.usefathom.com/script.js" data-site="EKJCVCTX" defer></script>
    
    <script>
      function updateTheme() {
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
      }
      updateTheme()
    </script>
  </head>

  <body class="text-xl text-slate-700 dark:bg-slate-900 dark:text-slate-400 min-h-screen flex flex-col">
    <header class="py-3 px-4 bg-gray-100 border-b dark:bg-slate-800/70 dark:border-slate-700">
      <div class="max-w-screen-sm md:max-w-screen-md mx-auto flex items-center">
        <div class="flex-1">
          <a class="text-lg xs:text-xl sm:text-2xl md:text-3xl font-semibold tracking-wide text-pink-700/80 hover:text-pink-800 dark:text-pink-500 dark:hover:text-pink-400 transition" href="/">
            Janko Marohnić
          </a>
        </div>

        <a class="flex items-center space-x-2 justify-self-center" href="/">
          <svg class="h-7 w-7 rounded lg:h-10 lg:w-10 lg:rounded-lg" role="img" aria-labelledby="logo-title" viewbox="0 0 64 64">
            <title id="logo-title">logo</title>
            <clippath id="topLeft"><path d="M64,0.025l-64,64l0,-64l64,0Z"></path></clippath>
            <clippath id="bottomRight"><path d="M0,64l64,-64l0,64l-64,0Z"></path></clippath>
            <g clip-path="url(#topLeft)"><rect class="fill-current text-pink-500" x="0.025" y="0.025" width="64" height="64"></rect><path class="fill-current text-white" d="M31.989,22.518c-0.031,-4.597 -0.902,-8.134 -2.612,-10.613c-1.71,-2.478 -4.165,-3.717 -7.365,-3.717c-3.2,0 -5.655,1.251 -7.365,3.753c-1.71,2.502 -2.565,6.114 -2.565,10.836l0,6.471c0.063,4.549 0.953,8.043 2.671,10.483c1.718,2.439 4.153,3.659 7.306,3.659c3.185,0 5.636,-1.255 7.354,-3.765c1.717,-2.51 2.576,-6.134 2.576,-10.871l0,-6.236Zm-6.682,7.647c-0.032,2.605 -0.31,4.538 -0.836,5.801c-0.525,1.263 -1.329,1.894 -2.412,1.894c-1.145,0 -1.988,-0.675 -2.529,-2.024c-0.542,-1.349 -0.812,-3.404 -0.812,-6.165l0,-8.541c0.078,-4.942 1.176,-7.413 3.294,-7.413c1.13,0 1.961,0.675 2.494,2.024c0.534,1.349 0.801,3.373 0.801,6.071l0,8.353Z"></path></g><g clip-path="url(#bottomRight)"><rect class="fill-current text-pink-700" x="0.025" y="0.025" width="64" height="64"></rect><path class="fill-current text-white" d="M44.945,55.261l-6.553,0l0,-25.659l-6.392,2.469l0,-5.446l12.253,-5.007l0.692,0l0,33.643Z"></path>&lt;
          </g></svg>
        </a>

        <span class="flex-1 flex space-x-2 justify-end">
          <button type="button" class="theme-reset rounded-full bg-sky-200 dark:bg-sky-900 px-2.5 py-1 text-xs font-medium text-sky-700 dark:text-white shadow-sm dark:hover:bg-sky-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-200">Reset to OS</button>

          <button type="button" class="theme-toggle bg-gray-200 relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transitikon-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-pink-700 focus:ring-offset-2 dark:focus:ring-pink-500 dark:focus:ring-offset-slate-900" role="switch" aria-checked="false">
            <span class="sr-only">Use setting</span>
            <span class="theme-toggle-ring translate-x-0 pointer-events-none relative inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out">
              <span class="theme-toggle-light opacity-100 duration-200 ease-in absolute inset-0 flex h-full w-full items-center justify-center transition-opacity" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4kkkkkkk h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"></path>
                </svg>
              </span>
              <span class="theme-toggle-dark opacity-0 duration-100 ease-out absolute inset-0 flex h-full w-full items-center justify-center transition-opacity" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-pink-500">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"></path>
                </svg>
              </span>
            </span>
          </button>
        </span>
      </div>
    </header>

    <div class="flex-1 my-2 sm:my-4 mx-4">
      <main class="max-w-screen-sm md:max-w-screen-md mx-auto">
        <article class="mt-6">
  <time datetime="2022-10-12" class="flex items-center text-slate-400 text-sm md:text-base">
    <span class="h-4 md:h-5 w-0.5 rounded-full bg-slate-200 dark:bg-slate-500"></span>
    <span class="ml-3">October 12, 2022</span>
  </time>

  <h1 class="mt-5 sm:mt-6 text-3xl sm:text-4xl lg:text-5xl font-semibold text-slate-900 tracking-tight dark:text-slate-100">What It Took to Build a Rails Integration for Rodauth</h1>

  <div class="mt-6 sm:mt-8 markdown">
    <p>When <a href="https://github.com/jeremyevans/rodauth">Rodauth</a> came out, I was excited to finally have a full-featured authentication framework that <em>wasn’t</em> tied to Rails, given that existing solutions required either Rails (Devise, Sorcery), or at least Active Record (Authlogic). Even though I mainly develop in Rails, I want other Ruby web frameworks to be viable alternatives, so I’m naturally drawn to generic solutions that everyone can use.</p>

<p>Even though Rodauth is built on top of <a href="https://github.com/jeremyevans/roda">Roda</a> and <a href="https://github.com/jeremyevans/sequel">Sequel</a>, it can work as a Rack middleware in any Ruby web framework. In the beginning, there was a <a href="https://github.com/jeremyevans/rodauth-demo-rails/blob/master/config/initializers/rodauth.rb">demo app</a> showing how Rodauth can be used in Rails, which leveraged the (now discontinued) <a href="https://github.com/jeremyevans/roda-rails">roda-rails</a> gem. However, the integration felt fairly raw, and definitely lacked the ergonomics Rails developers are used to.</p>

<p>Rodauth has a <a href="https://rodauth.jeremyevans.net/documentation.html#plugins">vast feature set</a>, but if it was going to compete with other authentication solutions, it needed to match their level of convenience in context of Rails. That meant deeply integrating into the Rails framework, having clear drawers where code goes, and defaults that are easy to get started with. At the start of 2020, I set on a mission to make using Rodauth in Rails easy.</p>

<h2 id="initial-spike">Initial spike</h2>

<p>I first created a <a href="https://github.com/janko/rodauth-demo-rails">demo Rails app</a>, and started setting up Rodauth there. In the <a href="https://github.com/janko/rodauth-demo-rails/commit/8affb9499801b6d2545f57b1554295f03502d2fa#diff-3c9dfcead9f75d230dc142b713a4bfc1e95faf07a3a027176b46519d95468453">early</a> <a href="https://github.com/janko/rodauth-demo-rails/commit/e69f9bd2149760d4d5e47ecf23d6239dc5448497#diff-c2af93c5a8391da5143ed228699395dc7ac8722b9e184abad40b4ea3213bacd5">iterations</a>, I managed to hook up view rendering, flash messages, CSRF protection, and email delivery to use Rails instead of Roda, with significantly less code compared to roda-rails. I also managed to make Rodauth code reloadable by inserting a proxy Rack middleware that just calls the Roda app.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/misc/rodauth_app.rb</span>
<span class="k">class</span> <span class="nc">RodauthApp</span> <span class="o">&lt;</span> <span class="no">Roda</span>
  <span class="n">plugin</span> <span class="ss">:rodauth</span><span class="p">,</span> <span class="ss">csrf: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">flash: </span><span class="kp">false</span> <span class="k">do</span>
    <span class="n">enable</span> <span class="ss">:rails</span><span class="p">,</span> <span class="ss">:login</span><span class="p">,</span> <span class="ss">:create_account</span><span class="p">,</span> <span class="ss">:verify_account</span><span class="p">,</span> <span class="ss">:reset_password</span><span class="p">,</span> <span class="ss">:logout</span>
    <span class="c1"># ... rodauth configuration ...</span>
  <span class="k">end</span>

  <span class="n">route</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
    <span class="n">r</span><span class="p">.</span><span class="nf">rodauth</span> <span class="c1"># handle rodauth requests</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lib/rodauth/features/rails.rb</span>
<span class="k">module</span> <span class="nn">Rodauth</span>
  <span class="no">Feature</span><span class="p">.</span><span class="nf">define</span><span class="p">(</span><span class="ss">:rails</span><span class="p">,</span> <span class="ss">:Rails</span><span class="p">)</span> <span class="k">do</span>
    <span class="c1"># ... rails integration ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/initializers/rodauth.rb</span>
<span class="k">class</span> <span class="nc">RodauthMiddleware</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="no">RodauthApp</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@app</span><span class="p">).</span><span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span> <span class="c1"># keeps RodauthApp reloadable</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">use</span> <span class="no">RodauthMiddleware</span>
</code></pre></div></div>

<p>Once I felt things were functioning well enough, I extracted the glue code into the <a href="https://github.com/janko/rodauth-rails">rodauth-rails</a> gem and added tests. I also included an install generator, which created the initial skeleton with sensible default configuration. A new Roda superclass provided a convenience <code class="language-plaintext highlighter-rouge">configure</code> method for loading the Rodauth plugin together with the <code class="language-plaintext highlighter-rouge">rails</code> feature.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bundle add rodauth-rails
<span class="nv">$ </span>rails generate rodauth:install
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/misc/rodauth_app.rb</span>
<span class="k">class</span> <span class="nc">RodauthApp</span> <span class="o">&lt;</span> <span class="no">Rodauth</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">App</span>
  <span class="n">configure</span> <span class="k">do</span> <span class="c1"># automatically loads the rails feature</span>
    <span class="n">enable</span> <span class="ss">:login</span><span class="p">,</span> <span class="ss">:create_account</span><span class="p">,</span> <span class="ss">:verify_account</span><span class="p">,</span> <span class="ss">:reset_password</span><span class="p">,</span> <span class="ss">:logout</span>
    <span class="c1"># ... rodauth configuration ...</span>
  <span class="k">end</span>

  <span class="n">route</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
    <span class="n">r</span><span class="p">.</span><span class="nf">rodauth</span> <span class="c1"># handle rodauth requests</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>By default, Rodauth uses database authentication functions for password matching, which coupled with a <a href="https://github.com/jeremyevans/rodauth#label-PostgreSQL+Database+Setup">two-user database setup</a> allows protecting password hashes even in case of SQL injection (<a href="https://github.com/jeremyevans/rodauth#label-Password+Hash+Access+Via+Database+Functions">read here</a> on how this works). However, I felt this complexity could be daunting when getting started, so I changed the default to do password matching in ruby instead.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">use_database_authentication_functions?</span> <span class="kp">false</span>
<span class="n">account_password_hash_column</span> <span class="ss">:password_hash</span>
</code></pre></div></div>

<p>Rodauth also optionally uses <a href="https://github.com/jeremyevans/rodauth#label-HMAC">HMACs</a> for signing tokens, providing additional security. Since this is quite important, rodauth-rails turns this on by setting the HMAC secret to the Rails’ secret key base.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hmac_secret</span> <span class="p">{</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secret_key_base</span> <span class="p">}</span>
</code></pre></div></div>

<h2 id="active-record">Active Record</h2>

<p>While Rodauth uses Sequel for database interaction, most Rails apps are using Active Record. This meant Rodauth needed to work seamlessly alongside Active Record.</p>

<p>One idea was to develop a Rodauth extension that replaces all Sequel calls with Active Record code. However, given Rodauth’s advanced SQL usage, that would’ve been a monumental effort. It would also have been a huge maintenance burden, since the extension would break with new Rodauth changes, and 3rd-party Rodauth extensions would need to maintain their own Active Record integrations.</p>

<p>So, the initial integration simply connected Sequel to the same database Active Record was connected to, which was then picked up by Rodauth.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">db_config</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection_db_config</span>

<span class="no">Sequel</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="ss">adapter: </span><span class="n">db_config</span><span class="p">.</span><span class="nf">adapter</span><span class="p">,</span> <span class="ss">database: </span><span class="n">db_config</span><span class="p">.</span><span class="nf">database</span><span class="p">)</span>
</code></pre></div></div>

<p>However, I noticed that this breaks features such as <a href="https://guides.rubyonrails.org/testing.html#maintaining-the-test-database-schema">maintaining test schema</a>, which requires temporarily disconnecting from the database in order to re-create the test database; even though Active Record connections were closed, Sequel was still holding an open connection, which was blocking database dropping. To address this, I extended Active Record to <a href="https://github.com/janko/rodauth-rails/blob/2b54cba3018d95940fd34af0bc0b17a540b8d2ea/lib/rodauth/rails/active_record_extension.rb">connect &amp; disconnect Sequel in lockstep with Active Record</a>.</p>

<p>This worked, but I quickly encountered a new kind of problem. Because Active Record and Sequel used separate database connections, Active Record code couldn’t reference records created within a Sequel transaction, because to that connection the record simply doesn’t exist (remember, database transactions are tied to a connection).</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Profile</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">RodauthApp</span> <span class="o">&lt;</span> <span class="no">Rodauth</span><span class="o">::</span><span class="no">Rails</span><span class="o">::</span><span class="no">App</span>
  <span class="n">configure</span> <span class="k">do</span>
    <span class="c1"># we're still in a Sequel transaction that created the account record</span>
    <span class="n">after_create_account</span> <span class="k">do</span>
      <span class="c1"># creating an associated record with Sequel worked:</span>
      <span class="c1"># db[:profiles].insert(account_id: account_id, name: "New User")</span>

      <span class="c1"># but with Active Record it failed with a foreign key constraint violation:</span>
      <span class="no">Profile</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">account_id: </span><span class="n">account_id</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"New User"</span><span class="p">)</span> <span class="c1"># ~&gt; account record not found</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>My goal was for developers not to have to care that Rodauth uses Sequel, so calling Active Record inside Rodauth should just work. Moreover, <a href="https://github.com/bruno-">Bruno Sutic</a> warned me if Sequel uses a separate database connection, it would mean production databases would have up to twice as many open connections. It became apparent this approach could never achieve the desired developer experience.</p>

<blockquote class="twitter-tweet" data-conversation="none">
<p lang="en" dir="ltr">Just browsed the repo. Sequel connection is a bummer.</p>— Josef Strzibny (@strzibnyj) <a href="https://twitter.com/strzibnyj/status/1253344181650518023?ref_src=twsrc%5Etfw">April 23, 2020</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>For the integration to work, I would need to make Sequel reuse Active Record’s database connection. I <a href="https://groups.google.com/g/sequel-talk/c/yQt4ptIDQO4/m/U7yghTFKBAAJ">discussed this idea with Jeremy Evans</a> (the lead Sequel maintainer), and he provided me with some guidance, thanks to which I was able to come up a <a href="https://github.com/janko/sequel-activerecord_connection">solution</a>. It was a Sequel extension that retrieved Active Record connections, kept transaction state and callbacks   synchronized between Sequel and Active Record, integrated SQL instrumentation, and reconciliated adapter differences (see my <a href="https://janko.io/how-i-enabled-sequel-to-reuse-active-record-connection/">previous article</a> for more details).</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bundle add sequel-activerecord_connection
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">DB</span> <span class="o">=</span> <span class="no">Sequel</span><span class="p">.</span><span class="nf">postgres</span><span class="p">(</span><span class="ss">extensions: :activerecord_connection</span><span class="p">)</span>
<span class="no">DB</span><span class="p">[</span><span class="ss">:accounts</span><span class="p">].</span><span class="nf">all</span> <span class="c1"># uses Active Record's database connection</span>
</code></pre></div></div>

<h2 id="model">Model</h2>

<p>Unlike Devise or Sorcery, Rodauth is completely decoupled from models, and any calls need to go through the Rodauth object. If you need to perform Rodauth actions outside of an HTTP request, you can use the <a href="http://rodauth.jeremyevans.net/rdoc/files/doc/internal_request_rdoc.html">internal request</a> feature, which makes an actual Rack call to the Rodauth app:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># performing rodauth actions (class level)</span>
<span class="no">RodauthApp</span><span class="p">.</span><span class="nf">rodauth</span><span class="p">.</span><span class="nf">create_account</span><span class="p">(</span><span class="ss">login: </span><span class="s2">"user@example.com"</span><span class="p">,</span> <span class="ss">password: </span><span class="s2">"secret123"</span><span class="p">)</span>
<span class="no">RodauthApp</span><span class="p">.</span><span class="nf">rodauth</span><span class="p">.</span><span class="nf">verify_account</span><span class="p">(</span><span class="ss">account_login: </span><span class="s2">"user@example.com"</span><span class="p">)</span>

<span class="c1"># calling rodauth methods (instance level)</span>
<span class="n">rodauth</span> <span class="o">=</span> <span class="no">Rodauth</span><span class="o">::</span><span class="no">Rails</span><span class="p">.</span><span class="nf">rodauth</span><span class="p">(</span><span class="ss">account_login: </span><span class="s2">"user@example.com"</span><span class="p">)</span>
<span class="n">rodauth</span><span class="p">.</span><span class="nf">get_password_reset_key</span><span class="p">(</span><span class="n">account_id</span><span class="p">)</span> <span class="c1">#=&gt; "DS6dtRNnvzSCWzm8jg4lltOzBE5vTN_xflNdToIPw3A"</span>
<span class="n">rodauth</span><span class="p">.</span><span class="nf">recovery_codes</span> <span class="c1">#=&gt; ["30GRJkr1BheZztvFZcDeRSNy6yhzigXH6zB-yvzP4Io", ...]</span>
</code></pre></div></div>

<p>While I love this decoupling, it would still be nice to be able to at least create accounts and retrieve associations directly through the model. So, I created the <a href="https://github.com/janko/rodauth-model">rodauth-model</a> gem, which provides an interface similar to Active Record’s <code class="language-plaintext highlighter-rouge">has_secure_password</code>, and defines associations based on your Rodauth configuration (together with associated models).</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">Rodauth</span><span class="o">::</span><span class="no">Rails</span><span class="p">.</span><span class="nf">model</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># generating a password hash</span>
<span class="n">account</span> <span class="o">=</span> <span class="no">Account</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">email: </span><span class="s2">"user@example.com"</span><span class="p">,</span> <span class="ss">password: </span><span class="s2">"secret123"</span><span class="p">)</span>
<span class="n">account</span><span class="p">.</span><span class="nf">password_hash</span> <span class="c1">#=&gt; "$2a$12$k/Ub1I2iomi84RacqY89Hu4.M0vK7klRnRtzorDyvOkVI.hKhkNw."</span>

<span class="n">account</span><span class="p">.</span><span class="nf">password_reset_key</span> <span class="c1">#=&gt; #&lt;Account::PasswordResetKey id: 1, key: "DS6dtRNnvzSCWzm8jg4lltOzBE5vTN_xflNdToIPw3A" ...&gt;</span>
<span class="n">account</span><span class="p">.</span><span class="nf">recovery_codes</span> <span class="c1">#=&gt; [#&lt;Account::RecoveryCode id: 1, code: "30GRJkr1BheZztvFZcDeRSNy6yhzigXH6zB-yvzP4Io"&gt;, ...]</span>
</code></pre></div></div>

<p>Rodauth stores account statuses (unverified, verified, closed) as integers, but we can use <a href="https://api.rubyonrails.org/classes/ActiveRecord/Enum.html"><code class="language-plaintext highlighter-rouge">ActiveRecord::Enum</code></a> to map them to strings, which is what the install generator now does.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># ...</span>
  <span class="n">enum</span> <span class="ss">:status</span><span class="p">,</span> <span class="ss">unverified: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">verified: </span><span class="mi">2</span><span class="p">,</span> <span class="ss">closed: </span><span class="mi">3</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">account</span> <span class="o">=</span> <span class="no">Account</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">account</span><span class="p">.</span><span class="nf">status</span> <span class="c1">#=&gt; "unverified"</span>

<span class="n">account</span><span class="p">.</span><span class="nf">verified?</span> <span class="c1">#=&gt; false</span>
<span class="n">account</span><span class="p">.</span><span class="nf">status</span> <span class="o">=</span> <span class="s2">"verified"</span>
<span class="n">account</span><span class="p">.</span><span class="nf">verified?</span> <span class="c1">#=&gt; true</span>

<span class="no">Account</span><span class="p">.</span><span class="nf">closed</span> <span class="c1">#=&gt; [#&lt;Account id: 456, status: "closed" ...&gt;, ...]</span>
</code></pre></div></div>

<h2 id="routes-introspection">Routes introspection</h2>

<p>In this architecture, Rodauth routes are handled by the Rack middleware that’s sitting in front of the Rails router. This has the benefit of allowing you to perform authentication actions such as requiring authentication, checking active sessions, and remembering from cookie in a single place, thus better encapsulating authentication logic.</p>

<p>However, since Rodauth routes aren’t registered within the Rails router, they don’t show up in <code class="language-plaintext highlighter-rouge">rails routes</code>. Rails’ routes introspection doesn’t currently have capability of registering custom routes, and Roda’s routing is <a href="https://janko.io/introduction-to-roda/">dynamic</a>, so it’s not possible to retrieve its routes programmatically.</p>

<p>Eventually I managed to implement a <a href="https://github.com/janko/rodauth-rails/blob/169e9e06bf9cf0dc4ecfe669af2f7f542bf5ba63/lib/rodauth/rails/tasks.rake"><code class="language-plaintext highlighter-rouge">rodauth:routes</code></a> Rake task, which retrieves the route paths from the Rodauth app, and parses the source code for HTTP verbs. It’s not ideal, but it should be good enough.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rails rodauth:routes
<span class="c"># Routes handled by RodauthApp:</span>
<span class="c"># </span>
<span class="c">#   GET/POST  /login                   rodauth.login_path</span>
<span class="c">#   GET/POST  /create-account          rodauth.create_account_path</span>
<span class="c">#   POST      /email-auth-request      rodauth.email_auth_request_path</span>
<span class="c">#   GET/POST  /email-auth              rodauth.email_auth_path</span>
<span class="c">#   GET/POST  /logout                  rodauth.logout_path</span>
<span class="c">#   GET/POST  /reset-password-request  rodauth.reset_password_request_path</span>
<span class="c">#   GET/POST  /reset-password          rodauth.reset_password_path</span>
<span class="c">#   GET/POST  /change-password         rodauth.change_password_path</span>
<span class="c">#   GET/POST  /change-login            rodauth.change_login_path</span>
<span class="c">#   GET/POST  /verify-login-change     rodauth.verify_login_change_path</span>
<span class="c">#   GET/POST  /close-account           rodauth.close_account_path</span>
<span class="c">#   GET/POST  /verify-account-resend   rodauth.verify_account_resend_path</span>
<span class="c">#   GET/POST  /verify-account          rodauth.verify_account_path</span>
<span class="c"># </span>
<span class="c">#   GET       /admin/multifactor-manage      rodauth(:admin).two_factor_manage_path</span>
<span class="c">#   GET       /admin/multifactor-auth        rodauth(:admin).two_factor_auth_path</span>
<span class="c">#   GET/POST  /admin/multifactor-disable     rodauth(:admin).two_factor_disable_path</span>
<span class="c">#   GET/POST  /admin/otp-auth                rodauth(:admin).otp_auth_path</span>
<span class="c">#   GET/POST  /admin/otp-setup               rodauth(:admin).otp_setup_path</span>
<span class="c">#   GET/POST  /admin/otp-disable             rodauth(:admin).otp_disable_path</span>
<span class="c">#   GET/POST  /admin/recovery-auth           rodauth(:admin).recovery_auth_path</span>
<span class="c">#   GET/POST  /admin/recovery-codes          rodauth(:admin).recovery_codes_path</span>
<span class="c">#   POST      /admin/unlock-account-request  rodauth(:admin).unlock_account_request_path</span>
<span class="c">#   GET/POST  /admin/unlock-account          rodauth(:admin).unlock_account_path</span>
</code></pre></div></div>

<h2 id="generators">Generators</h2>

<p>Before working on this gem, I didn’t realize how important code generators are for convenience, and also how difficult they are to get right. There are currently three generators rodauth-rails ships with:</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">rodauth:install</code> – sets up initial skeleton with default auth features and migrations</li>
  <li>
<code class="language-plaintext highlighter-rouge">rodauth:views</code> – imports ERB view templates for customization</li>
  <li>
<code class="language-plaintext highlighter-rouge">rodauth:migration</code> – generates migrations for selected authentication features</li>
</ul>

<p>The generators needed to handle various scenarios, such as RSpec vs Minitest, fixtures vs factory_bot, Active Record vs Sequel, different SQL adapters, API-only mode, UUID primary keys, and more.</p>

<h3 id="schema-migrations">Schema migrations</h3>

<p>I wanted to remove any Sequel code from sight, so I translated <a href="http://rodauth.jeremyevans.net/rdoc/files/README_rdoc.html#label-Creating+tables">Sequel migrations</a> into Active Record code, and generated those in Active Record migrations. If Sequel happens to be used as the main database library, we’d generate Sequel migrations instead.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rails generate rodauth:migration otp active_sessions
<span class="c"># create  db/migrate/20221012110706_create_rodauth_otp_active_sessions.rb</span>
</code></pre></div></div>
<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateRodauthOtpActiveSessions</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">7.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="c1"># Used by the otp feature</span>
    <span class="n">create_table</span> <span class="ss">:account_otp_keys</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">foreign_key</span> <span class="ss">:accounts</span><span class="p">,</span> <span class="ss">column: :id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:key</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:num_failures</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:last_use</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">default: </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="s2">"CURRENT_TIMESTAMP"</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="c1"># Used by the active sessions feature</span>
    <span class="n">create_table</span> <span class="ss">:account_active_session_keys</span><span class="p">,</span> <span class="ss">primary_key: </span><span class="p">[</span><span class="ss">:account_id</span><span class="p">,</span> <span class="ss">:session_id</span><span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:session_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:created_at</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">default: </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="s2">"CURRENT_TIMESTAMP"</span> <span class="p">}</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:last_use</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">default: </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="s2">"CURRENT_TIMESTAMP"</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="view-templates">View templates</h3>

<p>The <a href="https://github.com/jeremyevans/rodauth/tree/master/templates">built-in view templates</a> use <a href="https://github.com/rtomayko/tilt">Tilt</a>’s interpolated string engine, which avoids ERB dependency, but requires work to adapt for Rails. So, rodauth-rails’ views generator imports already converted <a href="https://github.com/janko/rodauth-rails/tree/2b54cba3018d95940fd34af0bc0b17a540b8d2ea/lib/generators/rodauth/templates/app/views/rodauth">ERB view templates</a> that use familiar Rails’ form helpers.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rails generate rodauth:views login create_account lockout 
<span class="c"># create  app/views/rodauth/_login_form.html.erb</span>
<span class="c"># create  app/views/rodauth/_login_form_footer.html.erb</span>
<span class="c"># create  app/views/rodauth/_login_form_header.html.erb</span>
<span class="c"># create  app/views/rodauth/login.html.erb</span>
<span class="c"># create  app/views/rodauth/multi_phase_login.html.erb</span>
<span class="c"># create  app/views/rodauth/create_account.html.erb</span>
<span class="c"># create  app/views/rodauth/unlock_account_request.html.erb</span>
<span class="c"># create  app/views/rodauth/unlock_account.html.erb</span>
</code></pre></div></div>
<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%=</span> <span class="n">form_with</span> <span class="ss">url: </span><span class="n">rodauth</span><span class="p">.</span><span class="nf">unlock_account_path</span><span class="p">,</span> <span class="ss">method: :post</span><span class="p">,</span> <span class="ss">data: </span><span class="p">{</span> <span class="ss">turbo: </span><span class="kp">false</span> <span class="p">}</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span><span class="o">=</span> <span class="n">rodauth</span><span class="p">.</span><span class="nf">unlock_account_explanatory_text</span> <span class="cp">%&gt;</span>

  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">rodauth</span><span class="p">.</span><span class="nf">unlock_account_requires_password?</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mb-3"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="s2">"password"</span><span class="p">,</span> <span class="n">rodauth</span><span class="p">.</span><span class="nf">password_label</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"form-label"</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">password_field</span> <span class="n">rodauth</span><span class="p">.</span><span class="nf">password_param</span><span class="p">,</span> <span class="ss">value: </span><span class="s2">""</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"password"</span><span class="p">,</span> <span class="ss">autocomplete: </span><span class="n">rodauth</span><span class="p">.</span><span class="nf">password_field_autocomplete_value</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"form-control </span><span class="si">#{</span><span class="s2">"is-invalid"</span> <span class="k">if</span> <span class="n">rodauth</span><span class="p">.</span><span class="nf">field_error</span><span class="p">(</span><span class="n">rodauth</span><span class="p">.</span><span class="nf">password_param</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">aria: </span><span class="p">({</span> <span class="ss">invalid: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">describedby: </span><span class="s2">"password_error_message"</span> <span class="p">}</span> <span class="k">if</span> <span class="n">rodauth</span><span class="p">.</span><span class="nf">field_error</span><span class="p">(</span><span class="n">rodauth</span><span class="p">.</span><span class="nf">password_param</span><span class="p">))</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">content_tag</span><span class="p">(</span><span class="ss">:span</span><span class="p">,</span> <span class="n">rodauth</span><span class="p">.</span><span class="nf">field_error</span><span class="p">(</span><span class="n">rodauth</span><span class="p">.</span><span class="nf">password_param</span><span class="p">),</span> <span class="ss">class: </span><span class="s2">"invalid-feedback"</span><span class="p">,</span> <span class="ss">id: </span><span class="s2">"password_error_message"</span><span class="p">)</span> <span class="k">if</span> <span class="n">rodauth</span><span class="p">.</span><span class="nf">field_error</span><span class="p">(</span><span class="n">rodauth</span><span class="p">.</span><span class="nf">password_param</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mb-3"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">submit</span> <span class="n">rodauth</span><span class="p">.</span><span class="nf">unlock_account_button</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"btn btn-primary"</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>Because not all Rodauth actions are Turbo-compatible (multi-phase login and viewing recovery codes return a 200 response on form submits), I have chosen to disable Turbo by default for all HTML forms, to ensure everything works.</p>

<h2 id="future-plans">Future plans</h2>

<ul>
  <li>
    <p>I would like the migration generator to support database authentication functions, to make it easier for developers to better secure their password hashes. I have been working on it on &amp; off, but it’s fairly complex to generate correct migration code, especially since different SQL databases (PostgreSQL, MySQL, SQL Server) require different setups.</p>
  </li>
  <li>
    <p>Default Rodauth view templates use Bootstrap markup, but Ben Koshy has been working on adding <a href="https://github.com/janko/rodauth-rails/pull/114">Tailwind CSS support</a>, which will be a nice addition. You’ll be able to pass <code class="language-plaintext highlighter-rouge">--css=tailwind</code>, which will be the default when the <code class="language-plaintext highlighter-rouge">tailwindcss-rails</code> gem is used.</p>
  </li>
  <li>
    <p>I want to make it easier for 3rd-party Rodauth extensions to provide migrations/views for Rails generators. The <a href="https://github.com/HoneyryderChuck/rodauth-oauth">rodauth-oauth</a> gem currently provides its own generators (<code class="language-plaintext highlighter-rouge">rodauth:oauth:install</code> and <code class="language-plaintext highlighter-rouge">rodauth:oauth:views</code>), but it would be nice if they didn’t have to be duplicated.</p>
  </li>
  <li>
    <p>Rodauth methods are called through the Rodauth object, and you’re encouraged to define convenience controller/view helpers that suit your application’s needs. That being said, having some default helpers <a href="https://github.com/heartcombo/devise#controller-filters-and-helpers">like Devise has</a> (and even something like <a href="https://github.com/heartcombo/devise/blob/6d32d2447cc0f3739d9732246b5a5bde98d9e032/lib/devise/controllers/helpers.rb#L18-L38">Devise groups</a>) probably might go a long way. I was also considering more convenient routing helpers, perhaps even a builder for defining custom ones.</p>

    <div class="language-rb highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c1"># config/routes.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="c1"># this is what we have today</span>
  <span class="n">constraints</span> <span class="no">Rodauth</span><span class="o">::</span><span class="no">Rails</span><span class="p">.</span><span class="nf">authenticated</span> <span class="k">do</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="c1"># but maybe Devise syntax is worthwhile</span>
  <span class="n">authenticate</span> <span class="k">do</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="closing-words">Closing words</h2>

<p>There are many more things the Rails integration takes care of, such as ignoring asset requests from Sprockets or Propshaft, instrumentation/logging of Rodauth requests, executing controller callbacks &amp; rescue handlers, handling background emails, testing helpers, and Rails 4.2+ &amp; JRuby support. But I think I rambled on for long enough.</p>

<p>The purpose for this article wasn’t to bolster on my achievements, but to share my realization about the price of convenience, and how much work it can actually take integrate a generic library into Rails, especially when it does the work of a Rails engine. I cannot thank Jeremy Evans enough for discussing, reviewing, and merging <a href="https://github.com/jeremyevans/rodauth/pulls?q=is%3Apr+author%3Ajanko">every one of my additions</a> to Rodauth that helped enable a smooth Rails integration <img class="emoji" title=":pray:" alt=":pray:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f64f.png" height="20" width="20"></p>

<p>I hope I fulfilled my goal of making Rodauth easy to work with in Rails. That being said, I’m grateful for the continuous feedback I’m getting from people that are using Rodauth. I’m trying to convert many of my answers into a <a href="https://github.com/janko/rodauth-rails/wiki">wiki page</a>, a <a href="https://rodauth.jeremyevans.net/documentation.html#guides">how-to guide</a> or a <a href="https://www.youtube.com/user/Junky098">screencast</a>, to grow the knowledge around handling common use cases.</p>


  </div>
</article>

<div class="mt-8 md:mt-10">
  <div class="flex items-center space-x-4 md:space-x-6 mx-0 lg:-mx-6 bg-blue-50 border border-sky-200 bg-sky-50 px-4 py-3 md:py-5 md:px-6 rounded-xl overflow-x-scroll dark:bg-sky-950 dark:border-sky-600">
  <img src="/images/me.jpg" class="h-20 w-20 xs:h-24 xs:w-24 sm:h-32 sm:w-32 rounded-xl">
  <div class="flex flex-col justify-center">
    
      <h3 class="font-medium text-slate-900 dark:text-slate-200 mb-2 text-xl xs:text-2xl">
        Janko Marohnić
      </h3>
    
    <p class="text-slate-900 dark:text-slate-200 text-sm xs:text-base md:text-lg hidden sm:block">
      Ruby developer, Rails critic, open source maintainer, creator of
      <a class="text-pink-700 underline dark:text-pink-500 decoration-pink-700/30 transition hover:text-pink-800 hover:decoration-pink-800 dark:hover:text-pink-400 dark:decoration-pink-500/40 dark:hover:decoration-pink-400" href="https://shrinerb.com" target="_blank">Shrine</a>,
      <a class="text-pink-700 underline dark:text-pink-500 decoration-pink-700/30 transition hover:text-pink-800 hover:decoration-pink-800 dark:hover:text-pink-400 dark:decoration-pink-500/40 dark:hover:decoration-pink-400" href="https://github.com/vim-test/vim-test" target="_blank">vim-test</a> and
      <a class="text-pink-700 underline dark:text-pink-500 decoration-pink-700/30 transition hover:text-pink-800 hover:decoration-pink-800 dark:hover:text-pink-400 dark:decoration-pink-500/40 dark:hover:decoration-pink-400" href="https://github.com/janko/rodauth-rails" target="_blank">rodauth-rails</a>.
    </p>

    <div class="mt-2 xs:mt-4 sm:mt-5 flex items-center space-x-3 xs:space-x-5">
      

      <a href="https://github.com/janko" title="GitHub" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out dark:hidden" viewbox="0 0 24 24">
          <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path>
        </svg>
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out hidden dark:block" viewbox="0 0 100 100">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z" fill="#fff"></path>
        </svg>
      </a>
      <a href="https://twitter.com/jankomarohnic" title="Twitter" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out" viewbox="0 0 20 20" fill="currentColor">
          <path fill="#1d9bf0" d="M17.316 6.246c0.008 0.162 0.011 0.326 0.011 0.488 0 4.99-3.797 10.742-10.74 10.742-2.133 0-4.116-0.625-5.787-1.697 0.296 0.035 0.596 0.053 0.9 0.053 1.77 0 3.397-0.604 4.688-1.615-1.651-0.031-3.046-1.121-3.526-2.621 0.23 0.043 0.467 0.066 0.71 0.066 0.345 0 0.679-0.045 0.995-0.131-1.727-0.348-3.028-1.873-3.028-3.703 0-0.016 0-0.031 0-0.047 0.509 0.283 1.092 0.453 1.71 0.473-1.013-0.678-1.68-1.832-1.68-3.143 0-0.691 0.186-1.34 0.512-1.898 1.861 2.285 4.644 3.787 7.781 3.945-0.064-0.277-0.097-0.564-0.097-0.861 0-2.084 1.689-3.773 3.774-3.773 1.086 0 2.067 0.457 2.756 1.191 0.859-0.17 1.667-0.484 2.397-0.916-0.282 0.881-0.881 1.621-1.66 2.088 0.764-0.092 1.49-0.293 2.168-0.594-0.506 0.758-1.146 1.422-1.884 1.953z"></path>
        </svg>
      </a>
      <a href="https://www.youtube.com/@jankomarohnic" title="YouTube" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out" viewbox="0 0 159 110" fill="currentColor">
          <path d="m154 17.5c-1.82-6.73-7.07-12-13.8-13.8-9.04-3.49-96.6-5.2-122 0.1-6.73 1.82-12 7.07-13.8 13.8-4.08 17.9-4.39 56.6 0.1 74.9 1.82 6.73 7.07 12 13.8 13.8 17.9 4.12 103 4.7 122 0 6.73-1.82 12-7.07 13.8-13.8 4.35-19.5 4.66-55.8-0.1-75z" fill="#f00"></path>
          <path d="m105 55-40.8-23.4v46.8z" fill="#fff"></path>
        </svg>
      </a>
      <a href="https://www.linkedin.com/in/janko-marohnic/" title="LinkedIn" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out" viewbox="0 0 72 72" width="72">
          <g fill="none" fill-rule="evenodd"><path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" fill="#007EBB"></path><path d="M62,62 L51.315625,62 L51.315625,43.8021149 C51.315625,38.8127542 49.4197917,36.0245323 45.4707031,36.0245323 C41.1746094,36.0245323 38.9300781,38.9261103 38.9300781,43.8021149 L38.9300781,62 L28.6333333,62 L28.6333333,27.3333333 L38.9300781,27.3333333 L38.9300781,32.0029283 C38.9300781,32.0029283 42.0260417,26.2742151 49.3825521,26.2742151 C56.7356771,26.2742151 62,30.7644705 62,40.051212 L62,62 Z M16.349349,22.7940133 C12.8420573,22.7940133 10,19.9296567 10,16.3970067 C10,12.8643566 12.8420573,10 16.349349,10 C19.8566406,10 22.6970052,12.8643566 22.6970052,16.3970067 C22.6970052,19.9296567 19.8566406,22.7940133 16.349349,22.7940133 Z M11.0325521,62 L21.769401,62 L21.769401,27.3333333 L11.0325521,27.3333333 L11.0325521,62 Z" fill="#FFF"></path></g>
        </svg>
      </a>
      <a href="https://speakerdeck.com/janko_m" title="Speaker Deck" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out" viewbox="0 0 256 160">
          <g><path d="M106.932331,100 L50,100 C22.3857624,100 0,77.6142376 0,50 C0,22.3857624 22.3857624,0 50,0 L116.421053,0 C127.466748,0 136.421053,8.9543048 136.421053,20 C136.421053,31.0456952 127.466748,40 116.421053,40 L48.977444,40 C43.454596,40 38.977444,44.4771528 38.977444,50 C38.977444,55.5228472 43.454596,60 48.977444,60 L105.909774,60 C133.524012,60 155.909774,82.3857624 155.909774,110 C155.909774,137.614238 133.524012,160 105.909774,160 L20,160 C8.9543048,160 0,151.045695 0,140 C0,128.954305 8.9543048,120 20,120 L106.932331,120 C112.455178,120 116.932331,115.522847 116.932331,110 C116.932331,104.477153 112.455178,100 106.932331,100 Z M149.013633,160 C162.31303,151.005667 171.818454,136.66797 174.567639,120 L206.843433,120 C212.273117,120 216.674746,115.522847 216.674746,110 L216.674746,50 C216.674746,44.4771528 212.273117,40 206.843433,40 L148.210526,40 C152.880793,34.6924352 155.720602,27.683544 155.720602,20 C155.720602,12.316456 152.880793,5.3075648 148.210526,0 L216.674746,0 C238.393484,0 256,17.9086104 256,40 L256,120 C256,142.09139 238.393484,160 216.674746,160 L149.013633,160 Z" fill="#009287"></path></g>
        </svg>
      </a>
      <a href="mailto:janko@hey.com" title="Email">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out text-red-500" viewbox="0 0 20 20" fill="currentColor">
          <path d="M1.574 5.286c0.488 0.262 7.248 3.894 7.5 4.029s0.578 0.199 0.906 0.199c0.328 0 0.654-0.064 0.906-0.199s7.012-3.767 7.5-4.029c0.489-0.263 0.951-1.286 0.054-1.286h-16.919c-0.897 0-0.435 1.023 0.053 1.286zM18.613 7.489c-0.555 0.289-7.387 3.849-7.727 4.027s-0.578 0.199-0.906 0.199-0.566-0.021-0.906-0.199-7.133-3.739-7.688-4.028c-0.39-0.204-0.386 0.035-0.386 0.219s0 7.293 0 7.293c0 0.42 0.566 1 1 1h16c0.434 0 1-0.58 1-1 0 0 0-7.108 0-7.292s0.004-0.423-0.387-0.219z"></path>
        </svg>
      </a>
    </div>
  </div>
</div>

</div>

<div class="mt-8 md:mt-10">
  
  <script src="https://utteranc.es/client.js" repo="janko/janko.io" issue-term="title" theme="preferred-color-scheme" crossorigin="anonymous" async>
  </script>


</div>

      </main>
    </div>

    <div class="border-t py-7 mt-10 bg-gray-50 dark:bg-slate-950 dark:border-slate-700">
      <footer class="max-w-screen-sm md:max-w-screen-md mx-auto flex flex-col space-y-2 md:flex-row md:justify-between md:space-y-0 text-base">
        <ul class="inline-flex space-x-4 font-medium justify-center md:justify-left">
          <li><a class="transition hover:text-pink-600" href="/">Articles</a></li>
          <li><a class="transition hover:text-pink-600" href="https://github.com/janko/janko.io">Source code</a></li>
        </ul>
        <p class="text-slate-500 text-center md:text-left">
          © 2023 Janko Marohnić. All rights reserved.
        </p>
      </footer>
    </div>

    <script>
      function toggleClass(element, classNames, force) {
        classNames.split(' ').forEach(function(className) {
          element.classList.toggle(className, force)
        })
      }

      const btnToggle = document.querySelector('.theme-toggle')
      const btnReset = document.querySelector('.theme-reset')

      function syncTheme() {
        const enabled = document.documentElement.classList.contains('dark')

        const ring = btnToggle.querySelector('.theme-toggle-ring')
        const light = btnToggle.querySelector('.theme-toggle-light')
        const dark = btnToggle.querySelector('.theme-toggle-dark')

        toggleClass(btnToggle, 'bg-pink-500', enabled)
        toggleClass(btnToggle, 'bg-slate-200', !enabled)

        toggleClass(ring, 'translate-x-5', enabled)
        toggleClass(ring, 'translate-x-0', !enabled)

        toggleClass(light, 'opacity-0 duration-100 ease-out', enabled)
        toggleClass(light, 'opacity-100 duration-200 ease-in', !enabled)

        toggleClass(dark, 'opacity-100 duration-200 ease-in', enabled)
        toggleClass(dark, 'opacity-0 duration-100 ease-out', !enabled)
      }

      btnToggle.addEventListener('click', function() {
        const enabled = document.documentElement.classList.toggle('dark')

        localStorage.theme = enabled ? 'dark' : 'light'

        syncTheme()

        btnReset.classList.remove('hidden')
      })

      btnReset.addEventListener('click', function() {
        localStorage.removeItem('theme')

        updateTheme()
        syncTheme()

        btnReset.classList.add('hidden')
      })

      syncTheme()
      btnReset.classList.toggle('hidden', !('theme' in localStorage))
    </script>
  </body>
</html>
