<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Ode to Sequel | Janko Marohnić</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/favicon.ico?v=1" sizes="any">
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Ode to Sequel" />
<meta name="author" content="Janko Marohnić" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I’ve used and loved ActiveRecord for most of my Ruby life. While I was in Rails, I couldn’t imagine why I would want to use anything else. When I moved away from Rails, I was still using ActiveRecord at first, but some things started to bother me:" />
<meta property="og:description" content="I’ve used and loved ActiveRecord for most of my Ruby life. While I was in Rails, I couldn’t imagine why I would want to use anything else. When I moved away from Rails, I was still using ActiveRecord at first, but some things started to bother me:" />
<link rel="canonical" href="https://janko.io/ode-to-sequel/" />
<meta property="og:url" content="https://janko.io/ode-to-sequel/" />
<meta property="og:site_name" content="Janko Marohnić" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-07-28T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Ode to Sequel" />
<meta name="twitter:site" content="@jankomarohnic" />
<meta name="twitter:creator" content="@jankomarohnic" />
<meta property="article:publisher" content="https://www.facebook.com/janko.marohnic/" />
<script type="application/ld+json">
{"headline":"Ode to Sequel","dateModified":"2015-07-28T00:00:00+02:00","datePublished":"2015-07-28T00:00:00+02:00","@type":"BlogPosting","author":{"@type":"Person","name":"Janko Marohnić"},"description":"I’ve used and loved ActiveRecord for most of my Ruby life. While I was in Rails, I couldn’t imagine why I would want to use anything else. When I moved away from Rails, I was still using ActiveRecord at first, but some things started to bother me:","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://janko.io/images/logo.png"},"name":"Janko Marohnić"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://janko.io/ode-to-sequel/"},"url":"https://janko.io/ode-to-sequel/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link type="application/atom+xml" rel="alternate" href="https://janko.io/feed.xml" title="Janko Marohnić" />
    <link rel="stylesheet" href="/css/bundle.css">
    
      <script src="https://cdn.usefathom.com/script.js" data-site="EKJCVCTX" defer></script>
    
    <script>
      function updateTheme() {
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
      }
      updateTheme()
    </script>
  </head>

  <body class="text-xl text-slate-700 dark:bg-slate-900 dark:text-slate-400 min-h-screen flex flex-col">
    <header class="py-3 px-4 bg-gray-100 border-b dark:bg-slate-800/70 dark:border-slate-700">
      <div class="max-w-screen-sm md:max-w-screen-md mx-auto flex items-center">
        <div class="flex-1">
          <a class="text-lg xs:text-xl sm:text-2xl md:text-3xl font-semibold tracking-wide text-pink-700/80 hover:text-pink-800 dark:text-pink-500 dark:hover:text-pink-400 transition" href="/">
            Janko Marohnić
          </a>
        </div>

        <a class="flex items-center space-x-2 justify-self-center" href="/">
          <svg class="h-7 w-7 rounded lg:h-10 lg:w-10 lg:rounded-lg" role="img" aria-labelledby="logo-title" viewBox="0 0 64 64">
            <title id="logo-title">logo</title>
            <clipPath id="topLeft"><path d="M64,0.025l-64,64l0,-64l64,0Z"></path></clipPath>
            <clipPath id="bottomRight"><path d="M0,64l64,-64l0,64l-64,0Z"></path></clipPath>
            <g clip-path="url(#topLeft)"><rect class="fill-current text-pink-500" x="0.025" y="0.025" width="64" height="64"></rect><path class="fill-current text-white" d="M31.989,22.518c-0.031,-4.597 -0.902,-8.134 -2.612,-10.613c-1.71,-2.478 -4.165,-3.717 -7.365,-3.717c-3.2,0 -5.655,1.251 -7.365,3.753c-1.71,2.502 -2.565,6.114 -2.565,10.836l0,6.471c0.063,4.549 0.953,8.043 2.671,10.483c1.718,2.439 4.153,3.659 7.306,3.659c3.185,0 5.636,-1.255 7.354,-3.765c1.717,-2.51 2.576,-6.134 2.576,-10.871l0,-6.236Zm-6.682,7.647c-0.032,2.605 -0.31,4.538 -0.836,5.801c-0.525,1.263 -1.329,1.894 -2.412,1.894c-1.145,0 -1.988,-0.675 -2.529,-2.024c-0.542,-1.349 -0.812,-3.404 -0.812,-6.165l0,-8.541c0.078,-4.942 1.176,-7.413 3.294,-7.413c1.13,0 1.961,0.675 2.494,2.024c0.534,1.349 0.801,3.373 0.801,6.071l0,8.353Z"></path></g><g clip-path="url(#bottomRight)"><rect class="fill-current text-pink-700" x="0.025" y="0.025" width="64" height="64"></rect><path class="fill-current text-white" d="M44.945,55.261l-6.553,0l0,-25.659l-6.392,2.469l0,-5.446l12.253,-5.007l0.692,0l0,33.643Z"></path><
          </svg>
        </a>

        <span class="flex-1 flex space-x-2 justify-end">
          <button type="button" class="theme-reset rounded-full bg-sky-200 dark:bg-sky-900 px-2.5 py-1 text-xs font-medium text-sky-700 dark:text-white shadow-sm dark:hover:bg-sky-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-200">Reset to OS</button>

          <button type="button" class="theme-toggle bg-gray-200 relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transitikon-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-pink-700 focus:ring-offset-2 dark:focus:ring-pink-500 dark:focus:ring-offset-slate-900" role="switch" aria-checked="false">
            <span class="sr-only">Use setting</span>
            <span class="theme-toggle-ring translate-x-0 pointer-events-none relative inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out">
              <span class="theme-toggle-light opacity-100 duration-200 ease-in absolute inset-0 flex h-full w-full items-center justify-center transition-opacity" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4kkkkkkk h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                </svg>
              </span>
              <span class="theme-toggle-dark opacity-0 duration-100 ease-out absolute inset-0 flex h-full w-full items-center justify-center transition-opacity" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-pink-500">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                </svg>
              </span>
            </span>
          </button>
        </span>
      </div>
    </header>

    <div class="flex-1 my-2 sm:my-4 mx-4">
      <main class="max-w-screen-sm md:max-w-screen-md mx-auto">
        <article class="mt-6">
  <time datetime="2015-07-28" class="flex items-center text-slate-400 text-sm md:text-base">
    <span class="h-4 md:h-5 w-0.5 rounded-full bg-slate-200 dark:bg-slate-500"></span>
    <span class="ml-3">July 28, 2015</span>
  </time>

  <h1 class="mt-5 sm:mt-6 text-3xl sm:text-4xl lg:text-5xl font-semibold text-slate-900 tracking-tight dark:text-slate-100">Ode to Sequel</h1>

  <div class="mt-6 sm:mt-8 markdown">
    <p>I’ve used and loved ActiveRecord for most of my Ruby life. While I was in
Rails, I couldn’t imagine why I would want to use anything else. When I moved
away from Rails, I was still using ActiveRecord at first, but some things
started to bother me:</p>

<ul>
  <li>limited query interface, you very quickly have to switch to SQL strings</li>
  <li>no good low-level query interface (Arel is not writable)</li>
  <li>very fuzzy LEFT JOIN support</li>
  <li>it’s <a href="https://github.com/janko/sinatra-activerecord/blob/e7cf306a03c80e12a0632f3d156b911c6ec9d12f/lib/sinatra/activerecord/rake/activerecord_4.rb">pretty</a> <a href="https://github.com/janko/sinatra-activerecord/blob/e7cf306a03c80e12a0632f3d156b911c6ec9d12f/lib/sinatra/activerecord/tasks.rake">difficult</a> to set up ActiveRecord in a
non-Rails project</li>
  <li>dependency on ActiveSupport and its core extensions (you may not want tons
of monkey patches if you’re using ActiveRecord outside of Rails)</li>
</ul>

<p>I wanted to try another ORM. I’ve thought about <a href="https://github.com/rom-rb/rom">ROM</a>, but I felt like it
required a completely different mindset. I wanted a gem which also implements
the <a href="http://www.martinfowler.com/eaaCatalog/activeRecord.html">ActiveRecord pattern</a>, but with a better implementation than the
ActiveRecord gem. I’ve heard about <strong><a href="http://sequel.jeremyevans.net/">Sequel</a></strong> before, and I decided it was
finally high time to try it out.</p>

<p>Since then I’ve had a fair amount of experience with Sequel and its community,
and it’s been amazing. Sequel has all the features I wanted from ActiveRecord,
and so much more, even features I didn’t know I wanted. Jeremy Evans, the
author of Sequel, keeps Sequel at <strong>0 issues</strong>, and also keeps a mailing list
where you can get help with <em>anything</em>.</p>

<p>I would like to give you some of my personal highlights of Sequel’s amazing
features.</p>

<p><em>NOTE: “Sequel” should not be confused with “Squeel”. Squeel is an extension for
ActiveRecord’s query DSL, while Sequel is a complete ORM and an alternative to
ActiveRecord.</em></p>

<h2 id="the-plugin-system">The plugin system</h2>

<p><img class="h-56 md:h-64 float-right" src="/images/sequel-plugin_system.png" alt="Sequel's plugin system" /></p>

<p>While ActiveRecord is one monolithic gem, Sequel utilizes a <a href="http://sequel.jeremyevans.net/plugins.html">plugin system</a>.
Sequel consists of a relatively thin <strong>core</strong>, which gives you the most common
behaviour, and you can then choose to add additional functionality via
<strong>plugins</strong>. Each plugin corresponds to a single file included in the gem, but
which is required only when the plugin is loaded.</p>

<div class="clear-both">
  
<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="nb">require</span> <span class="s2">"sequel"</span> <span class="c1"># loads the core</span>

  <span class="no">DB</span> <span class="o">=</span> <span class="no">Sequel</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="s2">"postgres:///my_database"</span><span class="p">)</span>

  <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:validation_helpers</span>
  <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:json_serializer</span>
  <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:nested_attributes</span>
  <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span><span class="p">.</span><span class="nf">plugin</span> <span class="ss">:single_table_inheritance</span>
  </code></pre></figure>

</div>

<p>Because of this design <a href="https://gist.github.com/janko/58e28d42fb268b0ac3c1#file-03-require-speed-rb">vanilla Sequel loads 5 times faster than
ActiveRecord</a>.</p>

<h2 id="query-interface">Query interface</h2>

<p>Sequel’s query interface is very similar to ActiveRecord’s, but much more
advanced.</p>

<h3 id="regular-expressions">Regular expressions</h3>

<p>Did you know that PostgresSQL and MySQL have support for POSIX regular
expressions? Neither did I. If you’re using one of these two databases, Sequel
will transform Ruby regular expressions to SQL:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Movie</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="sr">/future/</span><span class="p">)</span>
<span class="c1"># SELECT * FROM movies WHERE (name ~ 'future')</span>
<span class="no">Movie</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="sr">/future/i</span><span class="p">)</span> <span class="c1"># Case insensitive match</span>
<span class="c1"># SELECT * FROM movies WHERE (name ~* 'future')</span>
</code></pre></div></div>

<p>This means that you can simply replace all your ugly LIKE queries with
beautiful regular expressions! Just note that regex matches are usually slower
than LIKE queries (in my benchmarks they were twice as slow), so be sure to
measure in your application how this impacts the performance. If it does, LIKE
queries are still nicer to write in Sequel (see below).</p>

<h3 id="virtual-row-blocks">Virtual row blocks</h3>

<p>Most of Sequel’s query methods, in addition to arguments, also support blocks
(so-called “virtual row blocks”) which gives you a DSL for more advanced queries.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Movie</span><span class="p">.</span><span class="nf">where</span><span class="p">{</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2010</span><span class="p">}</span>                        <span class="c1"># inequality operators</span>
<span class="c1"># WHERE (year &gt;= 2010)</span>
<span class="no">Movie</span><span class="p">.</span><span class="nf">where</span><span class="p">{(</span><span class="n">title</span> <span class="o">=~</span> <span class="s2">"Batman"</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">year</span> <span class="o">&lt;</span> <span class="mi">2010</span><span class="p">)}</span> <span class="c1"># OR query</span>
<span class="c1"># WHERE ((title = 'Batman') OR (year &lt; 2010))</span>
<span class="no">Movie</span><span class="p">.</span><span class="nf">where</span><span class="p">{</span><span class="n">rating</span> <span class="o">&gt;=</span> <span class="n">avg</span><span class="p">(</span><span class="n">rating</span><span class="p">)}</span>               <span class="c1"># functions get translated to SQL</span>
<span class="c1"># WHERE (rating &gt;= avg(rating)</span>
<span class="no">Movie</span><span class="p">.</span><span class="nf">where</span><span class="p">{</span><span class="n">title</span><span class="p">.</span><span class="nf">like</span><span class="p">(</span><span class="s2">"%Future%"</span><span class="p">)}</span>              <span class="c1"># special methods</span>
<span class="c1"># WHERE (title LIKE '%FUTURE%')</span>
</code></pre></div></div>

<p>You may be familiar with this syntax if you’ve ever used the <a href="https://github.com/activerecord-hackery/squeel">Squeel</a> gem. This
is because Squeel originally borrowed this syntax from Sequel (hence the play of
characters in the name). But the problem with Squeel is that it’s essentially
an ActiveRecord hack, so it <a href="https://github.com/activerecord-hackery/squeel/issues/196">breaks</a> <a href="https://github.com/activerecord-hackery/squeel/issues/307">with</a> <a href="https://github.com/activerecord-hackery/squeel/pull/354">every</a>
ActiveRecord update. Virtual row blocks are a part of Sequel core, so they will
always remain fully stable.</p>

<p>While in ActiveRecord you often have to switch to SQL strings (OR query, LIKE
query, any non-canonic JOIN etc.), with Sequel’s virtual row blocks you
essentially <strong>never have to write SQL strings</strong>.</p>

<h3 id="low-level-usage">Low-level usage</h3>

<p>When working with large amounts of data, the time it takes to allocate all these
ActiveRecord objects can very quickly surpass the time it takes for actual
queries to execute. This is often the case in ActiveRecod migrations, where
you’re operating on whole production tables. Ideally you want to work instead
with light data structures, like hashes. However, as far as I know that’s not
possible when querying through ActiveRecord models.</p>

<p>Some more advanced ActiveRecord users might be thinking that <a href="https://github.com/rails/arel">Arel</a>, a library
that ActiveRecord uses underneath to build SQL queries, is a good fit here.
Performance-wise it probably is, but Arel is very difficult to use and <a href="https://gist.github.com/janko/2b2cea3e8e21d9232fb9">the
resulting code is often very unreadable</a> (even with <a href="https://github.com/camertron/arel-helpers">arel-helpers</a>).</p>

<p>On the other hand, Sequel allows you to write low-level queries using the
<strong>exact same</strong> query interface you use for models! Instead of going through
models, You can go through the <code class="language-plaintext highlighter-rouge">Sequel::Database</code> object directly, and the
records will be returned as simple Ruby hashes.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">DB</span> <span class="o">=</span> <span class="no">Sequel</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="s2">"postgres:///my_database"</span><span class="p">)</span> <span class="c1">#=&gt; #&lt;Sequel::Database&gt;</span>

<span class="no">Movie</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"Matrix"</span><span class="p">).</span><span class="nf">first</span>       <span class="c1">#=&gt; #&lt;Movie title="Matrix" year=1999 ...&gt;</span>
<span class="no">DB</span><span class="p">[</span><span class="ss">:movies</span><span class="p">].</span><span class="nf">where</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"Matrix"</span><span class="p">).</span><span class="nf">first</span> <span class="c1">#=&gt; {title: "Matrix", year: 1999, ...}</span>

<span class="c1"># DB[:movies].sql #=&gt; "SELECT * FROM movies"</span>
</code></pre></div></div>

<p>This means that with Sequel you can write very readable migrations (because you
don’t have to <a href="http://guides.rubyonrails.org/v3.2.8/migrations.html#using-models-in-your-migrations">redefine your models inside migrations</a>), and
have them be blazing-fast!</p>

<h2 id="model-design">Model design</h2>

<p>Where ActiveRecord uses class-level DSL, Sequel instead prefers simple OO
design. For example, the idiomatic way to write validations in Sequel is by
overriding the instance method <code class="language-plaintext highlighter-rouge">#validate</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Movie</span> <span class="o">&lt;</span> <span class="no">Sequel</span><span class="o">::</span><span class="no">Model</span>
  <span class="n">plugin</span> <span class="ss">:validation_helpers</span>

  <span class="k">def</span> <span class="nf">validate</span>
    <span class="n">validates_presence</span> <span class="p">[</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:year</span><span class="p">]</span>
    <span class="n">validates_includes</span> <span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="p">,</span> <span class="ss">:rating</span>
    <span class="k">if</span> <span class="n">genre</span> <span class="o">==</span> <span class="s2">"Horror"</span>
      <span class="n">validates_presence</span> <span class="ss">:rated</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>I personally find this way of writing validations much more natural than
ActiveRecord’s class-level DSL, since I’m not constrained to <code class="language-plaintext highlighter-rouge">:if</code> and
<code class="language-plaintext highlighter-rouge">:unless</code> options. As a bonus, if validations become more complex, I can pull
them out of the model into a service object, and still be able to use the
convenient helper methods (since they’re instance-level).</p>

<h2 id="joins">JOINs</h2>

<p>I’m not an SQL guru, but LEFT JOINs are really common in SQL. ActiveRecord
unfortunately doesn’t directly support LEFT JOINs. The <code class="language-plaintext highlighter-rouge">#join</code> method only does
an INNER JOIN by default, and while you can use it to write a custom JOIN
statement, it’s really verbose as you have to write the full SQL string with
all the column-joining logic.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># LEFT JOINs in ActiveRecord</span>
<span class="no">Movie</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="s2">"LEFT JOIN on directors ON directors.movie_id = movies.id"</span><span class="p">)</span>
</code></pre></div></div>

<p>You could also use <code class="language-plaintext highlighter-rouge">includes(:directors).refrences(:directors)</code>, which does a
LEFT JOIN, but this also eager loads your directors into memory, which is
unfortunate if you don’t need that.</p>

<p>Sequel, on the other hand, has support for <em>ALL</em> types of JOINs. You can do
joins through associations, or write them manually:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Movie</span><span class="p">.</span><span class="nf">association_left_join</span><span class="p">(</span><span class="ss">:directors</span><span class="p">)</span>     <span class="c1"># association_(left|right|inner|cross|...)_join</span>
<span class="no">Movie</span><span class="p">.</span><span class="nf">left_join</span><span class="p">(</span><span class="ss">:directors</span><span class="p">,</span> <span class="ss">movie_id: :id</span><span class="p">)</span>  <span class="c1"># (left|right|inner|cross|...)_join</span>
</code></pre></div></div>

<h2 id="postgres-specific-support">Postgres-specific support</h2>

<p>Jeremy Evans really loves Postgres (as everyone should), and he put a lot of
effort into supporting as many Postgres features as possible in Sequel. And
Postgres has a <em>LOT</em> of features.</p>

<h3 id="json">JSON</h3>

<p>Sequel supports reading and writing to JSON columns, but so does ActiveRecord,
so what’s the big deal? What ActiveRecord doesn’t have is an API for
<em>querying</em> JSON columns, which is the reason you’re using JSON columns in the
first place. The problem is that Postgres’ <a href="http://www.postgresql.org/docs/9.4/static/functions-json.html#FUNCTIONS-JSON-OP-TABLE">JSON operators</a> can be quite
cryptic, which hurts your codebase. Luckily, Sequel provides a nice, readable
API to help you with that:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Sequel</span><span class="p">.</span><span class="nf">extension</span> <span class="ss">:pg_json_ops</span> <span class="c1"># we load the plugin ("ops" stands for "operations")</span>

<span class="c1"># Let's say that the `movies` table has an "info" JSON column.</span>
<span class="n">info</span> <span class="o">=</span> <span class="no">Sequel</span><span class="p">.</span><span class="nf">pg_json_op</span><span class="p">(</span><span class="ss">:info</span><span class="p">)</span> <span class="c1"># we create a "JSON operation" object</span>

<span class="no">Movie</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="nf">has_key?</span><span class="p">(</span><span class="s1">'rated'</span><span class="p">))</span>                  <span class="c1"># WHERE (info ? 'rated')</span>
<span class="no">Movie</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="nf">get_text</span><span class="p">(</span><span class="s1">'rated'</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s1">'PG-13'</span><span class="p">)</span>       <span class="c1"># WHERE ((info -&gt;&gt; 'rated') = 'PG-13')</span>
<span class="no">Movie</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="nf">get_text</span><span class="p">([</span><span class="s1">'directors'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">]))</span> <span class="c1"># ORDER BY (info #&gt;&gt; ARRAY['directors', 1, 'name'])</span>
</code></pre></div></div>

<h3 id="views">Views</h3>

<p>Sequel makes it very simple and intuitive to write database views – just use
the query interface!</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">DB</span><span class="p">.</span><span class="nf">create_view</span> <span class="ss">:recent_ruby_items</span><span class="p">,</span> <span class="no">DB</span><span class="p">[</span><span class="ss">:items</span><span class="p">].</span><span class="nf">where</span><span class="p">(</span><span class="ss">category: </span><span class="s2">"ruby"</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="c1"># CREATE VIEW recent_ruby_items AS</span>
<span class="c1"># SELECT * from items WHERE category = 'ruby' LIMIT 5</span>
</code></pre></div></div>

<p>Database views are very helpful for DRYing up some common queries, as you can
query them as tables (Thoughtbot used views to implement <a href="https://robots.thoughtbot.com/implementing-multi-table-full-text-search-with-postgres">multi-table full-text
search in Postgres</a>). Moreover, unlike other databases,
Postgres has <a href="http://www.postgresql.org/docs/9.4/static/rules-materializedviews.html"><em>materialized</em> views</a>, which transforms views
into sort of temporary tables by caching them, <a href="http://webcache.googleusercontent.com/search?q=cache:8OnCH9RMeocJ:www.matchingnotes.com/caching-with-postgres-materialized-views.html+&amp;cd=1&amp;hl=en&amp;ct=clnk&amp;gl=us">which can really help you speed
up complex queries</a>. Sequel supports materialized views by
accepting <code class="language-plaintext highlighter-rouge">materialized: true</code> in <code class="language-plaintext highlighter-rouge">DB.create_view</code>.</p>

<h3 id="cursors">Cursors</h3>

<p>Sequel has a <code class="language-plaintext highlighter-rouge">#paged_each</code> method, which is an equivalent of ActiveRecord’s
<a href="http://api.rubyonrails.org/classes/ActiveRecord/Batches.html#method-i-find_each"><code class="language-plaintext highlighter-rouge">#find_each</code></a>. This method is used to iterate over large datasets
without having to load all records into memory. By default these methods use a
separate query for each iteration, changing LIMIT and OFFSET to mimic paging.</p>

<p>Sequel, if it detects you’re using Postgres, will instead change <code class="language-plaintext highlighter-rouge">#paged_each</code>
to use <a href="http://www.postgresql.org/docs/9.4/static/plpgsql-cursors.html">Postgres cursors</a> under the hood, which are faster than additional
queries and work with unordered datasets.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Movie</span><span class="p">.</span><span class="nf">paged_each</span> <span class="p">{</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span> <span class="o">...</span> <span class="p">}</span>
<span class="c1"># BEGIN;</span>
<span class="c1"># DECLARE sequel_cursor NO SCROLL CURSOR WITHOUT HOLD FOR SELECT * FROM "table";</span>
<span class="c1"># FETCH FORWARD 1000 FROM sequel_cursor</span>
<span class="c1"># FETCH FORWARD 1000 FROM sequel_cursor</span>
<span class="c1"># ...</span>
<span class="c1"># FETCH FORWARD 1000 FROM sequel_cursor</span>
<span class="c1"># CLOSE sequel_cursor</span>
<span class="c1"># COMMIT</span>
</code></pre></div></div>

<h3 id="sequel_pg">sequel_pg</h3>

<p><a href="https://github.com/jeremyevans/sequel_pg">sequel_pg</a> is a gem that provides a C extension which optimizes the fetching
of rows, generally resulting in a <a href="https://github.com/jeremyevans/sequel_pg#real-world-difference">2-6x speedup</a>. So, you just add the gem to
your Gemfile and get free performance.</p>

<p>In addition to optimization, sequel_pg also adds <a href="https://github.com/jeremyevans/sequel_pg#streaming">streaming support</a> if used on
PostgreSQL 9.2. Steaming support is similar to using a cursor, but it is faster
and more transparent. <code class="language-plaintext highlighter-rouge">#paged_each</code> will automatically use streaming to
implement paging if enabled.</p>

<h3 id="other-goodies">Other goodies</h3>

<ul>
  <li>Support for PostgresSQL’s LISTEN/NOTIFY commands (e.g. <a href="https://github.com/QueueClassic/queue_classic">queue_classic</a> uses
this feature):</li>
  <li><code class="language-plaintext highlighter-rouge">DB.loose_count(:users)</code> for fast approximate counts using Postgres’ system
tables (COUNT queries can be slow on larger tables)</li>
  <li>“<a href="http://sequel.jeremyevans.net/rdoc-plugins/classes/Sequel/Plugins/PgArrayAssociations.html">pg_array_associations</a>” plugin which enables you to avoid an additional
join table in “has and belongs to many” associations by keeping foreign keys
in a Postgres array column instead</li>
  <li>and many more…</li>
</ul>

<h2 id="switching-from-activerecord">Switching from ActiveRecord</h2>

<p>Sequel has a very exhaustive guide “<a href="http://sequel.jeremyevans.net/rdoc/files/doc/active_record_rdoc.html">Sequel for ActiveRecord Users</a>”, which is
aimed at helping ActiveRecord users transition to Sequel. The guide first
explains how <em>each</em> ActiveRecord feature is implemented in Sequel, and mentions
some Sequel plugins you could use in your transition to make Sequel more
similar to ActiveRecord. Then it lists how <em>each and every</em> ActiveRecord’s
method and option correspond to Sequel. Pretty good, huh?</p>

<p>There is a <a href="https://github.com/TalentBox/sequel-rails">sequel-rails</a> gem which is actively maintained, which helps you keep
the same development workflow as you had with Rails. It provides:</p>

<ul>
  <li>Database Rake tasks (for migrations and such)</li>
  <li>Migration/model generators</li>
  <li><code class="language-plaintext highlighter-rouge">Sequel::NoMatchingRow</code> error is returned as 404 (some other errors are
mapped as well)</li>
  <li>Logging is integrated into Rails logs</li>
  <li>And more…</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>Even after all of this, I have only scratched the surface of Sequel’s amazing
features. ActiveRecord was long my ORM of choice only because it’s part of
Rails, not because it was the best. After using Sequel for a period of time, I
have found it to be much more stable (0 issues maintained), better designed,
more performant (<a href="https://github.com/jeremyevans/simple_orm_benchmark">benchmark</a>), and more advanced than ActiveRecord. It
encourages you to make the most out of your database. I urge you to give it a
try!</p>


  </div>
</article>

<div class="mt-8 md:mt-10">
  <div class="flex items-center space-x-4 md:space-x-6 mx-0 lg:-mx-6 bg-blue-50 border border-sky-200 bg-sky-50 px-4 py-3 md:py-5 md:px-6 rounded-xl overflow-x-scroll dark:bg-sky-950 dark:border-sky-600">
  <img src="/images/me.jpg" class="h-20 w-20 xs:h-24 xs:w-24 sm:h-32 sm:w-32 rounded-xl">
  <div class="flex flex-col justify-center">
    
      <h3 class="font-medium text-slate-900 dark:text-slate-200 mb-2 text-xl xs:text-2xl">
        Janko Marohnić
      </h3>
    
    <p class="text-slate-900 dark:text-slate-200 text-sm xs:text-base md:text-lg hidden sm:block">
      Ruby developer, Rails critic, open source maintainer, creator of
      <a class="text-pink-700 underline dark:text-pink-500 decoration-pink-700/30 transition hover:text-pink-800 hover:decoration-pink-800 dark:hover:text-pink-400 dark:decoration-pink-500/40 dark:hover:decoration-pink-400" href="https://shrinerb.com" target="_blank">Shrine</a>,
      <a class="text-pink-700 underline dark:text-pink-500 decoration-pink-700/30 transition hover:text-pink-800 hover:decoration-pink-800 dark:hover:text-pink-400 dark:decoration-pink-500/40 dark:hover:decoration-pink-400" href="https://github.com/vim-test/vim-test" target="_blank">vim-test</a> and
      <a class="text-pink-700 underline dark:text-pink-500 decoration-pink-700/30 transition hover:text-pink-800 hover:decoration-pink-800 dark:hover:text-pink-400 dark:decoration-pink-500/40 dark:hover:decoration-pink-400" href="https://github.com/janko/rodauth-rails" target="_blank">rodauth-rails</a>.
    </p>

    <div class="mt-2 xs:mt-4 sm:mt-5 flex items-center space-x-3 xs:space-x-5">
      

      <a href="https://github.com/janko" title="GitHub" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out dark:hidden" viewBox="0 0 24 24">
          <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path>
        </svg>
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out hidden dark:block" viewBox="0 0 100 100">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z" fill="#fff"/>
        </svg>
      </a>
      <a href="https://twitter.com/jankomarohnic" title="Twitter" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out" viewBox="0 0 20 20" fill="currentColor">
          <path fill="#1d9bf0" d="M17.316 6.246c0.008 0.162 0.011 0.326 0.011 0.488 0 4.99-3.797 10.742-10.74 10.742-2.133 0-4.116-0.625-5.787-1.697 0.296 0.035 0.596 0.053 0.9 0.053 1.77 0 3.397-0.604 4.688-1.615-1.651-0.031-3.046-1.121-3.526-2.621 0.23 0.043 0.467 0.066 0.71 0.066 0.345 0 0.679-0.045 0.995-0.131-1.727-0.348-3.028-1.873-3.028-3.703 0-0.016 0-0.031 0-0.047 0.509 0.283 1.092 0.453 1.71 0.473-1.013-0.678-1.68-1.832-1.68-3.143 0-0.691 0.186-1.34 0.512-1.898 1.861 2.285 4.644 3.787 7.781 3.945-0.064-0.277-0.097-0.564-0.097-0.861 0-2.084 1.689-3.773 3.774-3.773 1.086 0 2.067 0.457 2.756 1.191 0.859-0.17 1.667-0.484 2.397-0.916-0.282 0.881-0.881 1.621-1.66 2.088 0.764-0.092 1.49-0.293 2.168-0.594-0.506 0.758-1.146 1.422-1.884 1.953z"></path>
        </svg>
      </a>
      <a href="https://www.youtube.com/@jankomarohnic" title="YouTube" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out" viewBox="0 0 159 110" fill="currentColor">
          <path d="m154 17.5c-1.82-6.73-7.07-12-13.8-13.8-9.04-3.49-96.6-5.2-122 0.1-6.73 1.82-12 7.07-13.8 13.8-4.08 17.9-4.39 56.6 0.1 74.9 1.82 6.73 7.07 12 13.8 13.8 17.9 4.12 103 4.7 122 0 6.73-1.82 12-7.07 13.8-13.8 4.35-19.5 4.66-55.8-0.1-75z" fill="#f00"/>
          <path d="m105 55-40.8-23.4v46.8z" fill="#fff"/>
        </svg>
      </a>
      <a href="https://www.linkedin.com/in/janko-marohnic/" title="LinkedIn" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out" viewBox="0 0 72 72" width="72">
          <g fill="none" fill-rule="evenodd"><path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" fill="#007EBB"/><path d="M62,62 L51.315625,62 L51.315625,43.8021149 C51.315625,38.8127542 49.4197917,36.0245323 45.4707031,36.0245323 C41.1746094,36.0245323 38.9300781,38.9261103 38.9300781,43.8021149 L38.9300781,62 L28.6333333,62 L28.6333333,27.3333333 L38.9300781,27.3333333 L38.9300781,32.0029283 C38.9300781,32.0029283 42.0260417,26.2742151 49.3825521,26.2742151 C56.7356771,26.2742151 62,30.7644705 62,40.051212 L62,62 Z M16.349349,22.7940133 C12.8420573,22.7940133 10,19.9296567 10,16.3970067 C10,12.8643566 12.8420573,10 16.349349,10 C19.8566406,10 22.6970052,12.8643566 22.6970052,16.3970067 C22.6970052,19.9296567 19.8566406,22.7940133 16.349349,22.7940133 Z M11.0325521,62 L21.769401,62 L21.769401,27.3333333 L11.0325521,27.3333333 L11.0325521,62 Z" fill="#FFF"/></g>
        </svg>
      </a>
      <a href="https://speakerdeck.com/janko_m" title="Speaker Deck" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out" viewBox="0 0 256 160">
          <g><path d="M106.932331,100 L50,100 C22.3857624,100 0,77.6142376 0,50 C0,22.3857624 22.3857624,0 50,0 L116.421053,0 C127.466748,0 136.421053,8.9543048 136.421053,20 C136.421053,31.0456952 127.466748,40 116.421053,40 L48.977444,40 C43.454596,40 38.977444,44.4771528 38.977444,50 C38.977444,55.5228472 43.454596,60 48.977444,60 L105.909774,60 C133.524012,60 155.909774,82.3857624 155.909774,110 C155.909774,137.614238 133.524012,160 105.909774,160 L20,160 C8.9543048,160 0,151.045695 0,140 C0,128.954305 8.9543048,120 20,120 L106.932331,120 C112.455178,120 116.932331,115.522847 116.932331,110 C116.932331,104.477153 112.455178,100 106.932331,100 Z M149.013633,160 C162.31303,151.005667 171.818454,136.66797 174.567639,120 L206.843433,120 C212.273117,120 216.674746,115.522847 216.674746,110 L216.674746,50 C216.674746,44.4771528 212.273117,40 206.843433,40 L148.210526,40 C152.880793,34.6924352 155.720602,27.683544 155.720602,20 C155.720602,12.316456 152.880793,5.3075648 148.210526,0 L216.674746,0 C238.393484,0 256,17.9086104 256,40 L256,120 C256,142.09139 238.393484,160 216.674746,160 L149.013633,160 Z" fill="#009287"></path></g>
        </svg>
      </a>
      <a href="mailto:janko@hey.com" title="Email">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out text-red-500" viewBox="0 0 20 20" fill="currentColor">
          <path d="M1.574 5.286c0.488 0.262 7.248 3.894 7.5 4.029s0.578 0.199 0.906 0.199c0.328 0 0.654-0.064 0.906-0.199s7.012-3.767 7.5-4.029c0.489-0.263 0.951-1.286 0.054-1.286h-16.919c-0.897 0-0.435 1.023 0.053 1.286zM18.613 7.489c-0.555 0.289-7.387 3.849-7.727 4.027s-0.578 0.199-0.906 0.199-0.566-0.021-0.906-0.199-7.133-3.739-7.688-4.028c-0.39-0.204-0.386 0.035-0.386 0.219s0 7.293 0 7.293c0 0.42 0.566 1 1 1h16c0.434 0 1-0.58 1-1 0 0 0-7.108 0-7.292s0.004-0.423-0.387-0.219z"></path>
        </svg>
      </a>
    </div>
  </div>
</div>

</div>

<div class="mt-8 md:mt-10">
  
  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'twinblog'; // required: replace example with your forum shortname
    var disqus_identifier = '/ode-to-sequel';
    var disqus_url = 'https://janko.io/ode-to-sequel/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



</div>

      </main>
    </div>

    <div class="border-t py-7 mt-10 bg-gray-50 dark:bg-slate-950 dark:border-slate-700">
      <footer class="max-w-screen-sm md:max-w-screen-md mx-auto flex flex-col space-y-2 md:flex-row md:justify-between md:space-y-0 text-base">
        <ul class="inline-flex space-x-4 font-medium justify-center md:justify-left">
          <li><a class="transition hover:text-pink-600" href="/">Articles</a></li>
          <li><a class="transition hover:text-pink-600" href="https://github.com/janko/janko.io">Source code</a></li>
        </ul>
        <p class="text-slate-500 text-center md:text-left">
          © 2023 Janko Marohnić. All rights reserved.
        </p>
      </footer>
    </div>

    <script>
      function toggleClass(element, classNames, force) {
        classNames.split(' ').forEach(function(className) {
          element.classList.toggle(className, force)
        })
      }

      const btnToggle = document.querySelector('.theme-toggle')
      const btnReset = document.querySelector('.theme-reset')

      function syncTheme() {
        const enabled = document.documentElement.classList.contains('dark')

        const ring = btnToggle.querySelector('.theme-toggle-ring')
        const light = btnToggle.querySelector('.theme-toggle-light')
        const dark = btnToggle.querySelector('.theme-toggle-dark')

        toggleClass(btnToggle, 'bg-pink-500', enabled)
        toggleClass(btnToggle, 'bg-slate-200', !enabled)

        toggleClass(ring, 'translate-x-5', enabled)
        toggleClass(ring, 'translate-x-0', !enabled)

        toggleClass(light, 'opacity-0 duration-100 ease-out', enabled)
        toggleClass(light, 'opacity-100 duration-200 ease-in', !enabled)

        toggleClass(dark, 'opacity-100 duration-200 ease-in', enabled)
        toggleClass(dark, 'opacity-0 duration-100 ease-out', !enabled)
      }

      btnToggle.addEventListener('click', function() {
        const enabled = document.documentElement.classList.toggle('dark')

        localStorage.theme = enabled ? 'dark' : 'light'

        syncTheme()

        btnReset.classList.remove('hidden')
      })

      btnReset.addEventListener('click', function() {
        localStorage.removeItem('theme')

        updateTheme()
        syncTheme()

        btnReset.classList.add('hidden')
      })

      syncTheme()
      btnReset.classList.toggle('hidden', !('theme' in localStorage))
    </script>
  </body>
</html>
