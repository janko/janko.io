<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>ActiveRecord is reinventing Sequel | Janko Marohnić</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/favicon.ico?v=1" sizes="any">
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="ActiveRecord is reinventing Sequel" />
<meta name="author" content="Janko Marohnić" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="For those who don’t know, Sequel is an ORM very similar to ActiveRecord, in a way that it also implements the Active Record pattern. As of this writing it’s 9 years old. I’ve already written about some of the main advantages of Sequel over ActiveRecord (and other people have as well: 1, 2)." />
<meta property="og:description" content="For those who don’t know, Sequel is an ORM very similar to ActiveRecord, in a way that it also implements the Active Record pattern. As of this writing it’s 9 years old. I’ve already written about some of the main advantages of Sequel over ActiveRecord (and other people have as well: 1, 2)." />
<link rel="canonical" href="https://janko.io/activerecord-is-reinventing-sequel/" />
<meta property="og:url" content="https://janko.io/activerecord-is-reinventing-sequel/" />
<meta property="og:site_name" content="Janko Marohnić" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-03-04T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="ActiveRecord is reinventing Sequel" />
<meta name="twitter:site" content="@jankomarohnic" />
<meta name="twitter:creator" content="@jankomarohnic" />
<meta property="article:publisher" content="https://www.facebook.com/janko.marohnic/" />
<script type="application/ld+json">
{"datePublished":"2016-03-04T00:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://janko.io/activerecord-is-reinventing-sequel/"},"author":{"@type":"Person","name":"Janko Marohnić"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://janko.io/images/logo.png"},"name":"Janko Marohnić"},"@type":"BlogPosting","description":"For those who don’t know, Sequel is an ORM very similar to ActiveRecord, in a way that it also implements the Active Record pattern. As of this writing it’s 9 years old. I’ve already written about some of the main advantages of Sequel over ActiveRecord (and other people have as well: 1, 2).","url":"https://janko.io/activerecord-is-reinventing-sequel/","headline":"ActiveRecord is reinventing Sequel","dateModified":"2016-03-04T00:00:00+01:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link type="application/atom+xml" rel="alternate" href="https://janko.io/feed.xml" title="Janko Marohnić" />
    <link rel="stylesheet" href="/css/bundle.css">
    
      <script src="https://cdn.usefathom.com/script.js" data-site="EKJCVCTX" defer></script>
    
    <script>
      function updateTheme() {
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
      }
      updateTheme()
    </script>
  </head>

  <body class="text-xl text-slate-700 dark:bg-slate-900 dark:text-slate-400 min-h-screen flex flex-col">
    <header class="py-3 px-4 bg-gray-100 border-b dark:bg-slate-800/70 dark:border-slate-700">
      <div class="max-w-screen-sm md:max-w-screen-md mx-auto flex items-center">
        <div class="flex-1">
          <a class="text-lg xs:text-xl sm:text-2xl md:text-3xl font-semibold tracking-wide text-pink-700/80 hover:text-pink-800 dark:text-pink-500 dark:hover:text-pink-400 transition" href="/">
            Janko Marohnić
          </a>
        </div>

        <a class="flex items-center space-x-2 justify-self-center" href="/">
          <svg class="h-7 w-7 rounded lg:h-10 lg:w-10 lg:rounded-lg" role="img" aria-labelledby="logo-title" viewbox="0 0 64 64">
            <title id="logo-title">logo</title>
            <clippath id="topLeft"><path d="M64,0.025l-64,64l0,-64l64,0Z"></path></clippath>
            <clippath id="bottomRight"><path d="M0,64l64,-64l0,64l-64,0Z"></path></clippath>
            <g clip-path="url(#topLeft)"><rect class="fill-current text-pink-500" x="0.025" y="0.025" width="64" height="64"></rect><path class="fill-current text-white" d="M31.989,22.518c-0.031,-4.597 -0.902,-8.134 -2.612,-10.613c-1.71,-2.478 -4.165,-3.717 -7.365,-3.717c-3.2,0 -5.655,1.251 -7.365,3.753c-1.71,2.502 -2.565,6.114 -2.565,10.836l0,6.471c0.063,4.549 0.953,8.043 2.671,10.483c1.718,2.439 4.153,3.659 7.306,3.659c3.185,0 5.636,-1.255 7.354,-3.765c1.717,-2.51 2.576,-6.134 2.576,-10.871l0,-6.236Zm-6.682,7.647c-0.032,2.605 -0.31,4.538 -0.836,5.801c-0.525,1.263 -1.329,1.894 -2.412,1.894c-1.145,0 -1.988,-0.675 -2.529,-2.024c-0.542,-1.349 -0.812,-3.404 -0.812,-6.165l0,-8.541c0.078,-4.942 1.176,-7.413 3.294,-7.413c1.13,0 1.961,0.675 2.494,2.024c0.534,1.349 0.801,3.373 0.801,6.071l0,8.353Z"></path></g><g clip-path="url(#bottomRight)"><rect class="fill-current text-pink-700" x="0.025" y="0.025" width="64" height="64"></rect><path class="fill-current text-white" d="M44.945,55.261l-6.553,0l0,-25.659l-6.392,2.469l0,-5.446l12.253,-5.007l0.692,0l0,33.643Z"></path>&lt;
          </g></svg>
        </a>

        <span class="flex-1 flex space-x-2 justify-end">
          <button type="button" class="theme-reset rounded-full bg-sky-200 dark:bg-sky-900 px-2.5 py-1 text-xs font-medium text-sky-700 dark:text-white shadow-sm dark:hover:bg-sky-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-200">Reset to OS</button>

          <button type="button" class="theme-toggle bg-gray-200 relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transitikon-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-pink-700 focus:ring-offset-2 dark:focus:ring-pink-500 dark:focus:ring-offset-slate-900" role="switch" aria-checked="false">
            <span class="sr-only">Use setting</span>
            <span class="theme-toggle-ring translate-x-0 pointer-events-none relative inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out">
              <span class="theme-toggle-light opacity-100 duration-200 ease-in absolute inset-0 flex h-full w-full items-center justify-center transition-opacity" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4kkkkkkk h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"></path>
                </svg>
              </span>
              <span class="theme-toggle-dark opacity-0 duration-100 ease-out absolute inset-0 flex h-full w-full items-center justify-center transition-opacity" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-pink-500">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"></path>
                </svg>
              </span>
            </span>
          </button>
        </span>
      </div>
    </header>

    <div class="flex-1 my-2 sm:my-4 mx-4">
      <main class="max-w-screen-sm md:max-w-screen-md mx-auto">
        <article class="mt-6">
  <time datetime="2016-03-04" class="flex items-center text-slate-400 text-sm md:text-base">
    <span class="h-4 md:h-5 w-0.5 rounded-full bg-slate-200 dark:bg-slate-500"></span>
    <span class="ml-3">March 04, 2016</span>
  </time>

  <h1 class="mt-5 sm:mt-6 text-3xl sm:text-4xl lg:text-5xl font-semibold text-slate-900 tracking-tight dark:text-slate-100">ActiveRecord is reinventing Sequel</h1>

  <div class="mt-6 sm:mt-8 markdown">
    <p>For those who don’t know, <a href="http://github.com/jeremyevans/sequel">Sequel</a> is an ORM very similar to ActiveRecord, in a
way that it also implements the <a href="http://www.martinfowler.com/eaaCatalog/activeRecord.html">Active Record pattern</a>. As of this writing
it’s 9 years old. I’ve already <a href="/ode-to-sequel/">written</a>
about some of the main advantages of Sequel over ActiveRecord (and other people
have as well:
<a href="http://rosenfeld.herokuapp.com/en/articles/ruby-rails/2013-12-18-sequel-is-awesome-and-much-better-than-activerecord">1</a>,
<a href="https://mrbrdo.wordpress.com/2013/10/15/why-you-should-stop-using-activerecord-and-start-using-sequel/">2</a>).</p>

<p>I’m using Sequel for over a year now, and am finding it to be consistently
better than ActiveRecord. But that’s just my opinion, right? You can’t really
say that one tool is objectively better than the other, each tool has its
tradeoffs.</p>

<p>Well, sometimes you simply can. What I’ve noticed is that, whenever a new shiny
ActiveRecord feature comes, Sequel has already had the same feature for quite
some time. That would be ok if these were a few isolated incidents, but
they’re really not. ActiveRecord appears to have been consistently reinventing
Sequel.</p>

<p>Wait, that can’t be right. ActiveRecord is insanely popular and it’s part of
Rails, the Rails team surely wouldn’t work so hard reimplementing something
that already exists. Anyway, that is a huge accusation, how can I possibly
prove my claims? Give me a chance, I really do have evidence. A <em>lot</em> of
evidence.</p>

<p>What I will do is walk you through ActiveRecord’s most notable updates, and
look for Sequel’s equivalents. I will also compare times when a feature landed
on both ORMs. I will list the features roughly in reverse chronological order
(from newest to oldest), so that we start from fresh memories.</p>

<h2 id="activerecord-5">ActiveRecord 5</h2>

<h3 id="or">OR</h3>

<p>The <code class="language-plaintext highlighter-rouge">ActiveRecord::Relation#or</code> query method allows use of the OR operator
(previously you’d have to write SQL strings):</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Post</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">id: </span><span class="mi">1</span><span class="p">).</span><span class="nf">or</span><span class="p">(</span><span class="no">Post</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">id: </span><span class="mi">2</span><span class="p">))</span>
<span class="c1"># =&gt; SELECT * FROM posts WHERE (id = 1) OR (id = 2)</span>
</code></pre></div></div>

<p>Implementing this feature required a
<a href="https://github.com/rails/rails/pull/9052">lot</a>
<a href="https://github.com/rails/rails/pull/18706">of</a>
<a href="https://github.com/rails/rails/pull/16052">discussion</a>.
The feature finally landed in ActiveRecord (<a href="https://github.com/rails/rails/commit/9e42cf019f2417473e7dcbfcb885709fa2709f89">commit</a>),
only <strong>8 years</strong> behind Sequel (<a href="https://github.com/jeremyevans/sequel/blob/305b965a2790675bc920f8d2d1a3bc194e366af4/lib/sequel/dataset/sql.rb#L235">code</a>).</p>

<h3 id="left-joins">Left joins</h3>

<p>The <code class="language-plaintext highlighter-rouge">ActiveRecord::Relation#left_joins</code> query method generates a LEFT OUTER
JOIN (previously kind of possible via <code class="language-plaintext highlighter-rouge">#eager_load</code>):</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">User</span><span class="p">.</span><span class="nf">left_joins</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span>
<span class="c1"># =&gt; SELECT "users".* FROM "users" LEFT OUTER JOIN "posts" ON "posts"."user_id" = "users"."id"</span>
</code></pre></div></div>

<p>The feature landed in ActiveRecord in 2015
(<a href="https://github.com/rails/rails/pull/12071">PR</a>). On the other hand, Sequel
has had support for all types of JOINs since <strong>2008</strong>, and added “association
joins” in <strong>2014</strong> (<a href="https://github.com/jeremyevans/sequel/commit/8dbec2f404703a0b265763c94af901f6053c22fa">commit</a>).</p>

<h3 id="attributes-api">Attributes API</h3>

<p>The <a href="http://edgeapi.rubyonrails.org/classes/ActiveRecord/Attributes/ClassMethods.html#method-i-attribute">attributes API</a>
allows specifying/overriding types of columns/accessors in your models, as well
as querying with instances of those types, and bunch of other things.</p>

<p>It’s difficult to point out at a specific equivalent in Sequel since the area
of ActiveRecord’s attributes API is so broad. In my opinion you can roughly
achieve the same features with <a href="http://sequel.jeremyevans.net/rdoc-plugins/classes/Sequel/Plugins/Serialization.html">serialization</a>, <a href="http://sequel.jeremyevans.net/rdoc-plugins/classes/Sequel/Plugins/SerializationModificationDetection.html">serialization_modification_detection</a>,
<a href="http://sequel.jeremyevans.net/rdoc-plugins/classes/Sequel/Plugins/Composition.html">composition</a>, <a href="http://sequel.jeremyevans.net/rdoc-plugins/classes/Sequel/Plugins/TypecastOnLoad.html">typecast_on_load</a>, and <a href="http://sequel.jeremyevans.net/rdoc-plugins/classes/Sequel/Plugins/DefaultsSetter.html">defaults_setter</a> plugins.</p>

<h3 id="views">Views</h3>

<p>The <code class="language-plaintext highlighter-rouge">ActiveRecord::ConnectionAdapters::AbstractAdapter#views</code> method defined on
connection adapters returns an array of database view names:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">views</span> <span class="c1">#=&gt; ["recent_posts", "popular_posts", ...]</span>
</code></pre></div></div>

<p>Sequel implemented <code class="language-plaintext highlighter-rouge">#views</code> in 2011
(<a href="https://github.com/jeremyevans/sequel/commit/ed27c3856fde5a5e03c4940db50fa93f4d9fd99a">commit</a>),
<strong>4 years</strong> before ActiveRecord (<a href="https://github.com/rails/rails/commit/dcd39949f8801cb4beddec37143a585259f09a2d">commit</a>).</p>

<h3 id="indexing-concurrently">Indexing Concurrently</h3>

<p>This PostgreSQL feature is crucial for zero-downtime migrations on larger
tables, ActiveRecord has had adding indices concurrently since 2013
(<a href="https://github.com/rails/rails/commit/e199dc1a570d4f0d9a07628268835bce5aab2732">commit</a>),
and dropping concurrently since 2015
(<a href="https://github.com/rails/rails/commit/ce17e232a12861bce4bd950d7143df3fe0cd1991">commit</a>).</p>

<p>Sequel supported both adding and dropping indices concurrently since <strong>2012</strong>
(<a href="https://github.com/jeremyevans/sequel/commit/61593033c05f5f52617f0c72bdc63d92a020bfff">commit</a>).</p>

<h3 id="in-batches">In batches</h3>

<p><code class="language-plaintext highlighter-rouge">ActiveRecord::Relation#in_batches</code> yields batches of relations, suitable for
batched updates or deletes:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Person</span><span class="p">.</span><span class="nf">in_batches</span> <span class="p">{</span> <span class="o">|</span><span class="n">people</span><span class="o">|</span> <span class="n">people</span><span class="p">.</span><span class="nf">update_all</span><span class="p">(</span><span class="ss">awesome: </span><span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div></div>

<p>Sequel doesn’t have an equivalent, because there is no one right way to do
batched updates, it depends on the situation. For example, the following Sequel
implementation in my benchmarks showed to be 2x faster than ActiveRecord’s:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="no">Person</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">).</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
  <span class="no">Person</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">id: </span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">1000</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">..</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)).</span><span class="nf">update</span><span class="p">(</span><span class="ss">awesome: </span><span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="aborting-hooks">Aborting hooks</h3>

<p>Before Rails 5, returning <code class="language-plaintext highlighter-rouge">false</code> in any <code class="language-plaintext highlighter-rouge">before_*</code> callback resulted in
halting of callback chain. The new version
<a href="https://github.com/rails/rails/pull/17227">removes</a> this behaviour and
requires you to be explicit about it:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="k">do</span>
    <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span> <span class="k">if</span> <span class="n">some_condition</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This is actually one of the rare cases where Sequel <a href="https://github.com/jeremyevans/sequel/commit/2475df6223b92923dffe0bc4de4eb6bf21eda640">added the equivalent
<code class="language-plaintext highlighter-rouge">cancel_action</code> method</a>
being inspired by ActiveRecord’s change <img class="emoji" title=":smiley:" alt=":smiley:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f603.png" height="20" width="20">.</p>

<h2 id="activerecord-4">ActiveRecord 4</h2>

<h3 id="adequate-record">Adequate Record</h3>

<p><a href="https://tenderlovemaking.com/2014/02/19/adequaterecord-pro-like-activerecord.html">Adequate Record</a> is a set of performance improvements in ActiveRecord that
makes common <code class="language-plaintext highlighter-rouge">find</code> and <code class="language-plaintext highlighter-rouge">find_by</code> calls and some association queries up to 2x
faster.</p>

<p>However, running the <a href="https://github.com/jeremyevans/simple_orm_benchmark">ORM benchmark</a> shows that Sequel is still much, much
faster than ActiveRecord, even after the Adequate Record merge.</p>

<h3 id="postgres-json-array-and-hstore">Postgres JSON, array and hstore</h3>

<p>ActiveRecord 4 added support for Postgres JSON, array and hstore columns, along
with automatic typecasting. From looking at the commits we can say that
ActiveRecord received these features roughly at the same time as Sequel
(<a href="http://sequel.jeremyevans.net/rdoc-plugins/files/lib/sequel/extensions/pg_json_rb.html">pg_json</a>, <a href="http://sequel.jeremyevans.net/rdoc-plugins/files/lib/sequel/extensions/pg_array_rb.html">pg_array</a>, <a href="http://sequel.jeremyevans.net/rdoc-plugins/files/lib/sequel/extensions/pg_hstore_rb.html">pg_hstore</a>), which is around the time these
features got added to Postgres. Note that Sequel on top of this also has an API
for <em>querying</em> these types of columns (<a href="http://sequel.jeremyevans.net/rdoc-plugins/files/lib/sequel/extensions/pg_json_ops_rb.html">pg_json_ops</a>, <a href="http://sequel.jeremyevans.net/rdoc-plugins/files/lib/sequel/extensions/pg_array_ops_rb.html">pg_array_ops</a>,
<a href="http://sequel.jeremyevans.net/rdoc-plugins/files/lib/sequel/extensions/pg_hstore_ops_rb.html">pg_hstore_ops</a>), which greatly improves readability.</p>

<h3 id="mutation-detection">Mutation detection</h3>

<p>ActiveRecord 4.2+ automatically detects in-place changes to columns values, and
marks the record as dirty. Sequel added this feature through
<a href="https://github.com/jeremyevans/sequel/commit/a9c4e060f436a9084d533c054395746cd8ae6bf1">modification_detection</a>
plugin after ActiveRecord. But note that in Sequel this is opt-in, so that
users can decide whether they want the performance hit.</p>

<h3 id="where-not">Where not</h3>

<p>The <code class="language-plaintext highlighter-rouge">where.not</code> query construct allows negating a <code class="language-plaintext highlighter-rouge">where</code> clause, eliminating
the need to write SQL strings:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Person</span><span class="p">.</span><span class="nf">where</span><span class="p">.</span><span class="nf">not</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"John"</span><span class="p">)</span>
</code></pre></div></div>

<p>It was added in 2012 (<a href="https://github.com/rails/rails/commit/de75af7acc5c05c708443de40e78965925165217">commit</a>),
in which time Sequel’s equivalent <code class="language-plaintext highlighter-rouge">exclude</code> was existing already for <strong>5 years</strong>
(<a href="https://github.com/jeremyevans/sequel/blob/305b965a2790675bc920f8d2d1a3bc194e366af4/lib/sequel/dataset/sql.rb#L263">code</a>).</p>

<h3 id="rewhere">Rewhere</h3>

<p>In 2013 <code class="language-plaintext highlighter-rouge">ActiveRecord::Relation#rewhere</code> was
<a href="https://github.com/rails/rails/commit/f950b2699f97749ef706c6939a84dfc85f0b05f2">added</a>
allowing you to overwrite all existing WHERE conditions with new ones:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Person</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Mr. Anderson"</span><span class="p">).</span><span class="nf">rewhere</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Neo"</span><span class="p">)</span>
</code></pre></div></div>

<p>Sequel has had <code class="language-plaintext highlighter-rouge">unfiltered</code>, which removes existing WHERE and HAVING conditions,
since 2008, <strong>5 years</strong> before this ActiveRecord update
(<a href="https://github.com/jeremyevans/sequel/commit/691a5c31a0f64d764a975c4bc563eb8de8b38507">commit</a>).</p>

<h3 id="enum">Enum</h3>

<p><code class="language-plaintext highlighter-rouge">ActiveRecord::Base#enum</code> was added to ActiveRecord 4.1
(<a href="https://github.com/rails/rails/commit/db41eb8a6ea88b854bf5cd11070ea4245e1639c5">commit</a>),
giving the ability to map names to integer columns:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Conversation</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">enum</span> <span class="ss">status: </span><span class="p">[</span><span class="ss">:active</span><span class="p">,</span> <span class="ss">:archived</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<p>While Sequel doesn’t have this database-agnostic feature, it has the <a href="http://sequel.jeremyevans.net/rdoc-plugins/files/lib/sequel/extensions/pg_enum_rb.html">pg_enum</a>
plugin for Postgres’ enum type, although it was added only 1 year after
ActiveRecord’s enum.</p>

<h3 id="automatic-inverse-associations">Automatic inverse associations</h3>

<p>ActiveRecord 4.1 added a feature to automatically detect inverse associations,
instead of having to always use <code class="language-plaintext highlighter-rouge">:inverse_of</code>
(<a href="https://github.com/rails/rails/commit/ae6e6d953084d1966e52cc06ffe24131f0115cc1">commit</a>).</p>

<p>Sequel had this basically since it added associations in 2008, which was about
<strong>5 years</strong> before ActiveRecord’s update.</p>

<h3 id="contextual-validations">Contextual validations</h3>

<p><a href="https://github.com/rails/rails/commit/50d971710150533562240bef660f14237b70d939">Contextual validations</a>
allow passing a symbol when validating, and doing validations depending on the
existence or absence of the given symbol.</p>

<p>Sequel doesn’t have this feature, since it’s a code smell to have this in the
model, but Sequel’s <a href="http://sequel.jeremyevans.net/rdoc/files/doc/validations_rdoc.html#label-validation_helpers">instance-level validations</a> allow you to validate records
from service objects, which is a much better way of doing contextual
validation.</p>

<h3 id="reversibility-improvements">Reversibility improvements</h3>

<p>ActiveRecord 4.0 improved writing reversible migrations by allowing destructive
methods like <code class="language-plaintext highlighter-rouge">remove_column</code> to be reversible, as well as adding a really handy
<code class="language-plaintext highlighter-rouge">ActiveRecord::Migration#reversible</code> method allowing you to write everything in
a <code class="language-plaintext highlighter-rouge">change</code>, not having to switch to <code class="language-plaintext highlighter-rouge">up</code> and <code class="language-plaintext highlighter-rouge">down</code>.</p>

<p>Sequel’s reversing capabilities are a bit lacking compared to ActiveRecord’s,
they are currently about the same as ActiveRecord’s before this change.</p>

<h3 id="null-relation">Null relation</h3>

<p>ActiveRecord 4.0 added a handy <code class="language-plaintext highlighter-rouge">ActiveRecord::Relation#none</code> which represents
an empty relation, effectively implementing a null object pattern for relations.</p>

<p>Sequel <a href="https://github.com/jeremyevans/sequel/commit/e1e3207583c39ec69ea030e29b331868308c672c">added a null_dataset
plugin</a>
as an inspiration to ActiveRecord’s feature.</p>

<h2 id="activerecord-3">ActiveRecord 3</h2>

<h3 id="explain">EXPLAIN</h3>

<p>In 2011 ActiveRecord 3.2 added <code class="language-plaintext highlighter-rouge">ActiveRecord::Relation#explain</code> for EXPLAIN-ing
queries
(<a href="https://github.com/rails/rails/commit/e7b7b4412380e7ce2d8e6ae402cb7fe02d7666b8">commit</a>).
Sequel has had EXPLAIN support for Postgres since 2007
(<a href="https://github.com/jeremyevans/sequel/blob/305b965a2790675bc920f8d2d1a3bc194e366af4/core/lib/sequel/adapters/postgres.rb#L365">code</a>),
and for MySQL was added only later in 2012
(<a href="https://github.com/jeremyevans/sequel/commit/7708ec277572ddf36eee3999f20e67bedb07ac5b">commit</a>).</p>

<h3 id="pluck">Pluck</h3>

<p>ActiveRecord 3.2 added <code class="language-plaintext highlighter-rouge">ActiveRecord::Relation#pluck</code> in 2011
(<a href="https://github.com/rails/rails/commit/a382d60f6abc94b6a965525872f858e48abc00de">commit</a>),
and added support for multiple columns in 2012 (<a href="https://github.com/rails/rails/commit/2e379c1e63b3646f9aff4d7e242ca37b4a57f529">commit</a>).</p>

<p>Sequel’s equivalent <code class="language-plaintext highlighter-rouge">Sequel::Dataset#select_map</code> existed since 2009
(<a href="https://github.com/jeremyevans/sequel/commit/ee3445294f5a83fdc02d5f03129eac839fdc74d2">commit</a>),
and support for multiple columns was added in 2011 (<a href="https://github.com/jeremyevans/sequel/commit/3075880a2e0c4b42cc064cb5c342eb879bd809a1">commit</a>).</p>

<h3 id="uniq">Uniq</h3>

<p>ActiveRecord 3.2 added SELECT DISTINCT through <code class="language-plaintext highlighter-rouge">ActiveRecord::Relation#uniq</code> in
2011 (<a href="https://github.com/rails/rails/commit/562583c7667f508493ab8c5b1a4215087fafd22d">commit</a>).
Sequel has had equivalent <code class="language-plaintext highlighter-rouge">Sequel::Dataset#distinct</code> since 2007
(<a href="https://github.com/jeremyevans/sequel/blob/a3c54c62a16b74218ba2311fb482b0b625972cd5/sequel_core/lib/sequel_core/dataset/sql.rb#L264">code</a>),
<strong>4 years</strong> ahead of ActiveRecord.</p>

<h3 id="update-column">Update column</h3>

<p>ActiveRecord 3.1. added <code class="language-plaintext highlighter-rouge">ActiveRecord::Base#update_column</code> for updating
attributes without executing validations or callbacks
(<a href="https://github.com/rails/rails/commit/245542ea2994961731be105db6c076256a22a7a9">commit</a>).
The equivalent behaviour in Sequel, <code class="language-plaintext highlighter-rouge">user.this.update(...)</code>, at that moment
already existed for <strong>4 years</strong>.</p>

<h3 id="reversible-migrations">Reversible migrations</h3>

<p>ActiveRecord 3.1 added support for reversible migrations via <code class="language-plaintext highlighter-rouge">change</code>
(<a href="https://github.com/jeremyevans/sequel/commit/94450d775dfdc1b6cc0393944198bfa2ea0ecd71">commit</a>).
Soon after that, and inspired by ActiveRecord, Sequel added its support for
reversible migrations (<a href="https://github.com/jeremyevans/sequel/commit/94450d775dfdc1b6cc0393944198bfa2ea0ecd71">commit</a>).</p>

<h3 id="arel">Arel</h3>

<p>Finally, we come probably to ActiveRecord’s biggest update: the chainable query
interface and extraction of <a href="https://github.com/rails/arel">Arel</a>. For those who don’t know, ActiveRecord
prior to 3.0 didn’t have a chainable query interface.</p>

<p>Sequel already had this chainable query interface, before Nick Kallen started
working on Arel (<a href="http://sequel.jeremyevans.net/2010/02/06/arel-sequel-differences-part-1.html">source</a>),
meaning he was obviously inspired by Sequel. Also, building queries with Arel
looks very different than through models (it’s arguably more clunky), while
Sequel’s low-level interface gives you the exact same API as you have through
models.</p>

<p>Alternative to Arel for building complex queries is <a href="https://github.com/activerecord-hackery/squeel">Squeel</a>. Beside the
obvious insipration indicated by the anagram in the name (even though there is
no mention of it in the README), the interface obviously mimics Sequel’s
<a href="http://sequel.jeremyevans.net/rdoc/files/doc/virtual_rows_rdoc.html">virtual row blocks</a>.</p>

<h2 id="aftermath">Aftermath</h2>

<p>In this detailed overview, even though Sequel was ahead of ActiveRecord in vast
majority of cases, there were a few cases where ActiveRecord was leading the
way:</p>

<ul>
  <li>Reversible migrations</li>
  <li>Aborting hooks</li>
  <li>Mutation detection</li>
  <li>Enum (kind of)</li>
  <li>Null relation</li>
</ul>

<p>We see that Sequel was closely keeping up with ActiveRecord, but ActiveRecord
wasn’t keeping up with Sequel. Note that on GitHub Sequel maintains 0 open
issues, while ActiveRecord circles around 300 open issues. It’s also worth
mentioning that Sequel is maintained mainly by one developer, while
ActiveRecord is developed by most of the Rails team.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I want that you think about this. ActiveRecord was mainly implementing features
that Sequel already had. That could be justified if ActiveRecord had some other
advantages over Sequel, but I’m failing to see them. I don’t classify
integration with Rails as an advantage (you can just make a <a href="https://github.com/TalentBox/sequel-rails">sequel-rails</a> for
that), I mean advantages that actually help interacting with databases.</p>

<p>I wished that I used Sequel from day one, instead of starting with ActiveRecord
and slowly realizing that Sequel is better. The only reason ActiveRecord is so
popular is because it’s part of Rails, not because it’s better. There is a
reason why <a href="https://github.com/hanami/model">hanami-model</a> and <a href="https://github.com/rom-rb/rom-sql">ROM</a> use Sequel under-the-hood and not
ActiveRecord. It hurts me that so many developer hours are put into
ActiveRecord, and I don’t see for what purpose; a better tool already exists
and is excellently maintainted. Let’s direct our energy towards the better
tool.</p>


  </div>
</article>

<div class="mt-8 md:mt-10">
  <div class="flex items-center space-x-4 md:space-x-6 mx-0 lg:-mx-6 bg-blue-50 border border-sky-200 bg-sky-50 px-4 py-3 md:py-5 md:px-6 rounded-xl overflow-x-scroll dark:bg-sky-950 dark:border-sky-600">
  <img src="/images/me.jpg" class="h-20 w-20 xs:h-24 xs:w-24 sm:h-32 sm:w-32 rounded-xl">
  <div class="flex flex-col justify-center">
    
      <h3 class="font-medium text-slate-900 dark:text-slate-200 mb-2 text-xl xs:text-2xl">
        Janko Marohnić
      </h3>
    
    <p class="text-slate-900 dark:text-slate-200 text-sm xs:text-base md:text-lg hidden sm:block">
      Ruby developer, Rails critic, open source maintainer, creator of
      <a class="text-pink-700 underline dark:text-pink-500 decoration-pink-700/30 transition hover:text-pink-800 hover:decoration-pink-800 dark:hover:text-pink-400 dark:decoration-pink-500/40 dark:hover:decoration-pink-400" href="https://shrinerb.com" target="_blank">Shrine</a>,
      <a class="text-pink-700 underline dark:text-pink-500 decoration-pink-700/30 transition hover:text-pink-800 hover:decoration-pink-800 dark:hover:text-pink-400 dark:decoration-pink-500/40 dark:hover:decoration-pink-400" href="https://github.com/vim-test/vim-test" target="_blank">vim-test</a> and
      <a class="text-pink-700 underline dark:text-pink-500 decoration-pink-700/30 transition hover:text-pink-800 hover:decoration-pink-800 dark:hover:text-pink-400 dark:decoration-pink-500/40 dark:hover:decoration-pink-400" href="https://github.com/janko/rodauth-rails" target="_blank">rodauth-rails</a>.
    </p>

    <div class="mt-2 xs:mt-4 sm:mt-5 flex items-center space-x-3 xs:space-x-5">
      

      <a href="https://github.com/janko" title="GitHub" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out dark:hidden" viewbox="0 0 24 24">
          <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path>
        </svg>
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out hidden dark:block" viewbox="0 0 100 100">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z" fill="#fff"></path>
        </svg>
      </a>
      <a href="https://twitter.com/jankomarohnic" title="Twitter" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out" viewbox="0 0 20 20" fill="currentColor">
          <path fill="#1d9bf0" d="M17.316 6.246c0.008 0.162 0.011 0.326 0.011 0.488 0 4.99-3.797 10.742-10.74 10.742-2.133 0-4.116-0.625-5.787-1.697 0.296 0.035 0.596 0.053 0.9 0.053 1.77 0 3.397-0.604 4.688-1.615-1.651-0.031-3.046-1.121-3.526-2.621 0.23 0.043 0.467 0.066 0.71 0.066 0.345 0 0.679-0.045 0.995-0.131-1.727-0.348-3.028-1.873-3.028-3.703 0-0.016 0-0.031 0-0.047 0.509 0.283 1.092 0.453 1.71 0.473-1.013-0.678-1.68-1.832-1.68-3.143 0-0.691 0.186-1.34 0.512-1.898 1.861 2.285 4.644 3.787 7.781 3.945-0.064-0.277-0.097-0.564-0.097-0.861 0-2.084 1.689-3.773 3.774-3.773 1.086 0 2.067 0.457 2.756 1.191 0.859-0.17 1.667-0.484 2.397-0.916-0.282 0.881-0.881 1.621-1.66 2.088 0.764-0.092 1.49-0.293 2.168-0.594-0.506 0.758-1.146 1.422-1.884 1.953z"></path>
        </svg>
      </a>
      <a href="https://www.youtube.com/@jankomarohnic" title="YouTube" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out" viewbox="0 0 159 110" fill="currentColor">
          <path d="m154 17.5c-1.82-6.73-7.07-12-13.8-13.8-9.04-3.49-96.6-5.2-122 0.1-6.73 1.82-12 7.07-13.8 13.8-4.08 17.9-4.39 56.6 0.1 74.9 1.82 6.73 7.07 12 13.8 13.8 17.9 4.12 103 4.7 122 0 6.73-1.82 12-7.07 13.8-13.8 4.35-19.5 4.66-55.8-0.1-75z" fill="#f00"></path>
          <path d="m105 55-40.8-23.4v46.8z" fill="#fff"></path>
        </svg>
      </a>
      <a href="https://www.linkedin.com/in/janko-marohnic/" title="LinkedIn" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out" viewbox="0 0 72 72" width="72">
          <g fill="none" fill-rule="evenodd"><path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" fill="#007EBB"></path><path d="M62,62 L51.315625,62 L51.315625,43.8021149 C51.315625,38.8127542 49.4197917,36.0245323 45.4707031,36.0245323 C41.1746094,36.0245323 38.9300781,38.9261103 38.9300781,43.8021149 L38.9300781,62 L28.6333333,62 L28.6333333,27.3333333 L38.9300781,27.3333333 L38.9300781,32.0029283 C38.9300781,32.0029283 42.0260417,26.2742151 49.3825521,26.2742151 C56.7356771,26.2742151 62,30.7644705 62,40.051212 L62,62 Z M16.349349,22.7940133 C12.8420573,22.7940133 10,19.9296567 10,16.3970067 C10,12.8643566 12.8420573,10 16.349349,10 C19.8566406,10 22.6970052,12.8643566 22.6970052,16.3970067 C22.6970052,19.9296567 19.8566406,22.7940133 16.349349,22.7940133 Z M11.0325521,62 L21.769401,62 L21.769401,27.3333333 L11.0325521,27.3333333 L11.0325521,62 Z" fill="#FFF"></path></g>
        </svg>
      </a>
      <a href="https://speakerdeck.com/janko_m" title="Speaker Deck" target="_blank">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out" viewbox="0 0 256 160">
          <g><path d="M106.932331,100 L50,100 C22.3857624,100 0,77.6142376 0,50 C0,22.3857624 22.3857624,0 50,0 L116.421053,0 C127.466748,0 136.421053,8.9543048 136.421053,20 C136.421053,31.0456952 127.466748,40 116.421053,40 L48.977444,40 C43.454596,40 38.977444,44.4771528 38.977444,50 C38.977444,55.5228472 43.454596,60 48.977444,60 L105.909774,60 C133.524012,60 155.909774,82.3857624 155.909774,110 C155.909774,137.614238 133.524012,160 105.909774,160 L20,160 C8.9543048,160 0,151.045695 0,140 C0,128.954305 8.9543048,120 20,120 L106.932331,120 C112.455178,120 116.932331,115.522847 116.932331,110 C116.932331,104.477153 112.455178,100 106.932331,100 Z M149.013633,160 C162.31303,151.005667 171.818454,136.66797 174.567639,120 L206.843433,120 C212.273117,120 216.674746,115.522847 216.674746,110 L216.674746,50 C216.674746,44.4771528 212.273117,40 206.843433,40 L148.210526,40 C152.880793,34.6924352 155.720602,27.683544 155.720602,20 C155.720602,12.316456 152.880793,5.3075648 148.210526,0 L216.674746,0 C238.393484,0 256,17.9086104 256,40 L256,120 C256,142.09139 238.393484,160 216.674746,160 L149.013633,160 Z" fill="#009287"></path></g>
        </svg>
      </a>
      <a href="mailto:janko@hey.com" title="Email">
        <svg class="w-5 h-5 xs:w-6 xs:h-6 sm:w-7 sm:h-7 transition hover:scale-[1.2] duration-200 ease-in ease-out text-red-500" viewbox="0 0 20 20" fill="currentColor">
          <path d="M1.574 5.286c0.488 0.262 7.248 3.894 7.5 4.029s0.578 0.199 0.906 0.199c0.328 0 0.654-0.064 0.906-0.199s7.012-3.767 7.5-4.029c0.489-0.263 0.951-1.286 0.054-1.286h-16.919c-0.897 0-0.435 1.023 0.053 1.286zM18.613 7.489c-0.555 0.289-7.387 3.849-7.727 4.027s-0.578 0.199-0.906 0.199-0.566-0.021-0.906-0.199-7.133-3.739-7.688-4.028c-0.39-0.204-0.386 0.035-0.386 0.219s0 7.293 0 7.293c0 0.42 0.566 1 1 1h16c0.434 0 1-0.58 1-1 0 0 0-7.108 0-7.292s0.004-0.423-0.387-0.219z"></path>
        </svg>
      </a>
    </div>
  </div>
</div>

</div>

<div class="mt-8 md:mt-10">
  
  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'twinblog'; // required: replace example with your forum shortname
    var disqus_identifier = '/activerecord-is-reinventing-sequel';
    var disqus_url = 'https://janko.io/activerecord-is-reinventing-sequel/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



</div>

      </main>
    </div>

    <div class="border-t py-7 mt-10 bg-gray-50 dark:bg-slate-950 dark:border-slate-700">
      <footer class="max-w-screen-sm md:max-w-screen-md mx-auto flex flex-col space-y-2 md:flex-row md:justify-between md:space-y-0 text-base">
        <ul class="inline-flex space-x-4 font-medium justify-center md:justify-left">
          <li><a class="transition hover:text-pink-600" href="/">Articles</a></li>
          <li><a class="transition hover:text-pink-600" href="https://github.com/janko/janko.io">Source code</a></li>
        </ul>
        <p class="text-slate-500 text-center md:text-left">
          © 2023 Janko Marohnić. All rights reserved.
        </p>
      </footer>
    </div>

    <script>
      function toggleClass(element, classNames, force) {
        classNames.split(' ').forEach(function(className) {
          element.classList.toggle(className, force)
        })
      }

      const btnToggle = document.querySelector('.theme-toggle')
      const btnReset = document.querySelector('.theme-reset')

      function syncTheme() {
        const enabled = document.documentElement.classList.contains('dark')

        const ring = btnToggle.querySelector('.theme-toggle-ring')
        const light = btnToggle.querySelector('.theme-toggle-light')
        const dark = btnToggle.querySelector('.theme-toggle-dark')

        toggleClass(btnToggle, 'bg-pink-500', enabled)
        toggleClass(btnToggle, 'bg-slate-200', !enabled)

        toggleClass(ring, 'translate-x-5', enabled)
        toggleClass(ring, 'translate-x-0', !enabled)

        toggleClass(light, 'opacity-0 duration-100 ease-out', enabled)
        toggleClass(light, 'opacity-100 duration-200 ease-in', !enabled)

        toggleClass(dark, 'opacity-100 duration-200 ease-in', enabled)
        toggleClass(dark, 'opacity-0 duration-100 ease-out', !enabled)
      }

      btnToggle.addEventListener('click', function() {
        const enabled = document.documentElement.classList.toggle('dark')

        localStorage.theme = enabled ? 'dark' : 'light'

        syncTheme()

        btnReset.classList.remove('hidden')
      })

      btnReset.addEventListener('click', function() {
        localStorage.removeItem('theme')

        updateTheme()
        syncTheme()

        btnReset.classList.add('hidden')
      })

      syncTheme()
      btnReset.classList.toggle('hidden', !('theme' in localStorage))
    </script>
  </body>
</html>
